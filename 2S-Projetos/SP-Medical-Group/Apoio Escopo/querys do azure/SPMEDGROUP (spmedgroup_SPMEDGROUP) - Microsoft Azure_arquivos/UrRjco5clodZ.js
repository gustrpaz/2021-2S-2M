define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/DraftResponseParser",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/Draft/DraftMetadataUtils"],(function(n,t,i,r){"use strict";function f(n,t){var u="",f=n.lastIndexOf("#"),i=n.substring(0,f),e=n.substr(f+1,n.length),o=r.isCustomDimension(i);return o&&(i=r.DraftCustomDimensionPrefix+"["+i.substring(r.DraftCustomDimensionPrefix.length)+"]"),t.forEach((function(n,t){n=n&&"'"+n.replace(/'/g,'"')+"'"||"null";t!==0&&(u+=e==="ne"?" and ":" or ");u+=i+" "+e+" "+n})),u}Object.defineProperty(t,"__esModule",{value:!0});t.DraftMetricsQueryBuilder=void 0;var u=(function(){function n(n,t,i,r){this._resourceId=n;this._top=t;this._sort=i;this._interval=r;this._metricAggregationMap={};this._filterMap={}}return n.prototype.addMetric=function(n,t){this._metricAggregationMap[n.name]=t},n.prototype.setSegment=function(n){this._segment=n},n.prototype.addFilter=function(n){var t=n.operator===1?i.notEqualsString:i.equalsString;this._filterMap[n.dimensionId+"#"+t]=n.value},n.prototype._getDraftAggregateFilterClause=function(){var n=this,t=Object.keys(this._filterMap).map((function(t){return"("+f(t,n._filterMap[t])+")"})).join(" and ");return"("+t+")"},n.prototype.createQueryPayload=function(n,t,i){var r=this,f=t.startTime.toISOString(),e=t.endTime.toISOString(),u=[];return Object.keys(this._metricAggregationMap).forEach((function(t){var o={metricId:t,timespan:f+"/"+e},s,h;Object.keys(r._filterMap).length>0&&(o.filter=r._getDraftAggregateFilterClause());r._segment&&(o.segment="["+r._segment+"]");s=r._metricAggregationMap[t];i||(o.aggregation=s);h=n&5;h&&(o.interval=r._interval);o.top=r._top||10;h&&o.top>0&&(o.top=3*o.top);r._sort&&s&&(o.orderby=s+(r._sort===1?" asc":" desc"));u.push({id:""+r._resourceId+t+"#"+s+"#"+(h?"Series":"Summary"),parameters:o})})),u},n})();t.DraftMetricsQueryBuilder=u}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/AiArmKusto.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/ServiceContainer","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/TimeUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/Draft/DraftMetadataUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/DraftResponseParser","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Telemetry","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/Draft/DraftMetadataUtils"],(function(n,t,i,r,u,f,e,o,s){"use strict";function h(n,t,i,r,u,f,e,o){e===void 0&&(e="GET");var s={type:e,resourceId:i,uri:r,dataType:"json",setAuthorizationHeader:!0,contentType:"application/json",data:o};return n.fetchDraftWithRetry(s,{resourceId:i,queryName:u},t,f)}function a(n,t,r){var f=[],u;return n&&n.metrics?(u={},Object.keys(n.metrics).forEach((function(r){var e=n.metrics[r],o=s.isCustomMetric(r),h={metricId:{resourceDefinition:{id:t},name:{id:r,displayName:e.displayName},namespace:{name:i.AIKustoNamespace}},category:{id:s.getDraftCategoryName(r,o)},supportedAggregations:s.getSupportedAggregations(e.supportedAggregations,o,s.DraftAggregationValueToEnumNames[e.defaultAggregation]),defaultAggregation:s.DraftAggregationValueToEnumNames[e.defaultAggregation],supportedGroupBy:e.supportedGroupBy.all,description:e.description,unit:s.convertDraftMetricUnit(e.units)};u[e.displayName]?u[e.displayName].push(r):u[e.displayName]=[r];f.push(h)})),f=f.filter((function(n){return s.fixMetricDisplayName(u,n)}))):o.logWarning("Draft.Provider.transformMetricMetadata: metadata collection is falsy",r),f}function v(n,t){return t.then((function(t){return n.map((function(n){var i=t.dimensions,r=i&&i[n]&&i[n].displayName||n,u=n.substring(0,s.DraftCustomDimensionPrefix.length)===s.DraftCustomDimensionPrefix?"Custom":"Standard";return{dimensionName:{id:n,displayName:r},category:{id:u}}}))}))}function y(n,t,i,r,u,f,e){return!n||!t?[]:i.map((function(n){var o=n.name,h=n.aggregation||s.DraftAggregationValueToEnumNames[d(t,o)]||0,c,l;return n.aggregation=h,c=f?w(t,f,i):p(t,o,s.getDraftAggregationValue(h)),l=k(t,o),{metric:n,startTime:r.startTime,endTime:r.endTime,timeGrain:u,data:c,timeRangeExtended:e,unit:b(t,o),displayName:l}}))}function p(n,t,i){var u=n&&n[0],f;if(u){var e=u.body&&u.body.value,o=[],r=n[1];return r&&(f=r.body&&r.body.value&&r.body.value.segments,o=f&&f.map((function(n){return{timestamp:new Date(n.start),value:n[t][i]}}))),[{dataPoints:o,summary:e&&e[t][i]},]}return[]}function w(n,t,i){var u=n&&n[0],f,e,r;if(u&&(f=u.body&&u.body.value&&u.body.value.segments,f)){e=[];r=n[1];r&&(e=r.body&&r.body.value&&r.body.value.segments);var o=s.getDraftDimensionKey(t),h=i[0].name,c=s.getDraftAggregationValue(i[0].aggregation);return f.map((function(n){var i=n[o];return{dataPoints:g(e,i,o,h,c),summary:n[h][c],segment:[{key:t,value:i}]}}))}return[]}function b(n,t){var i=n[0]&&n[0].body&&n[0].body[c],r=i&&i.metrics;if(r)return s.convertDraftMetricUnit(r[t].units)}function k(n,t){var i=n[0]&&n[0].body&&n[0].body[c],r=i&&i.metrics;return r&&r[t].displayName}function d(n,t){var i=n[0]&&n[0].body,r=i&&i.value&&i.value[t];return r||(i=n[1]&&n[1].body,r=i&&i.value&&i.value.segments&&i.value.segments[0]&&i.value.segments[0][t]),Object.keys(r)&&Object.keys(r)[0]}function g(n,t,i,r,u){var f=[];return n&&n.forEach((function(n){n&&n.segments.forEach((function(e){e[i]===t&&f.push({timestamp:new Date(n.start),value:e[r][u]})}))})),f}var l,c;Object.defineProperty(t,"__esModule",{value:!0});t.fetchArmKusto=t.AiArmKustoProvider=void 0;l=(function(){function n(n,t,u){this.id=1;this._resourceId=n&&n.id;this._resourceId||(this._resourceId=r.ServiceContainer.Instance().get(i.TypeNames.ResourceId));this._ajaxHelper=t;this._telemetryContext=u;this._queryParameters="?useKusto=true&useMDM=false&prefer=ai.include-metadata,ai.ignoreInvalidFilterDimensions=true&api-version=2018-04-20"}return n.prototype.getNamespaces=function(){return Q([{name:i.AIKustoNamespace,category:i.NamespaceOptionType.Standard}])},n.prototype.getMetricDefinitions=function(n,t,i){var r=this;return i&&(this._draftMetadataPromise=null),(this._draftMetadataPromise||this._issueMetadataQueryInternal(n)).then((function(n){return a(n,r._resourceId,r._telemetryContext)}))},n.prototype._getSelectedMetricDefinitions=function(n,t,i){return!n||n.length===0?Q([]):this.getMetricDefinitions(t,undefined,i).then((function(t){var i={};return n.forEach((function(n){i[n.name]=!0})),t.filter((function(n){return i[n.metricId.name.id]}))}))},n.prototype.getDimensionDefinitions=function(n,t,i){var r=this;return this._getSelectedMetricDefinitions(n,t,i).then((function(n){var i=n.reduce((function(n,t){var i=t.supportedGroupBy;return i?n.concat(i):n}),[]),u=r._draftMetadataPromise||r._issueMetadataQueryInternal(t);return v(i,u)}))},n.prototype.getDimensionValues=function(n,t,r,u,o,s){var c=new e.DraftMetricsQueryBuilder(this._resourceId,u,0),l,a;return n.forEach((function(n){c.addMetric(n)})),r&&r.forEach((function(n){c.addFilter(n)})),c.setSegment(t),l=""+this._resourceId+"/metrics"+this._queryParameters,a=c.createQueryPayload(8,o,!0),h(this._ajaxHelper,this._telemetryContext,this._resourceId,l,i.QueryNames.AiArmKustoGetDimensionValues,s,"POST",a).then((function(n){var r=[],i=n&&n[0]&&n[0].body,u=i&&i.value&&i.value.segments,e;return u&&(e=f.getDraftDimensionKey(t),u.forEach((function(n){r.push({value:n[e]})}))),r}))},n.prototype.getMetricResults=function(n,t){var b=this,c=n.metrics,w=n.filters,r=n.splitBy,l=n.timerange,v=n.timegrain,a,p;if(c&&c.length>0){var k=""+this._resourceId+"/metrics"+this._queryParameters,o=[],s=new e.DraftMetricsQueryBuilder(this._resourceId,r&&r.top,r&&r.sort,v);return c.forEach((function(n){s.addMetric(n,f.getDraftAggregationValue(n.aggregation))})),w&&w.forEach((function(n){s.addFilter(n)})),a=r&&r.dimensionId,a&&s.setSegment(a),o.push.apply(o,s.createQueryPayload(10,l)),p=u.expandTimespan(l,v,n.isRelativeTime)||l,(!n.fetchDataKind||n.fetchDataKind&5)&&o.push.apply(o,s.createQueryPayload(5,p)),h(this._ajaxHelper,this._telemetryContext,this._resourceId,k,i.QueryNames.AiArmKustoMetricResult,t,"POST",o).then((function(n){return y(b._resourceId,n,c,l,v,a,p)||[]}))}return Q([])},n.prototype._issueMetadataQueryInternal=function(n){var t=""+this._resourceId+"/metrics/metadata"+this._queryParameters;return this._draftMetadataPromise=h(this._ajaxHelper,this._telemetryContext,this._resourceId,t,i.QueryNames.AiArmKustoMetadata,n),this._draftMetadataPromise},n})();t.AiArmKustoProvider=l;t.fetchArmKusto=h;c="@ai.metadata"}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils",["require","exports"],(function(n,t){"use strict";function i(t){return MsPortalFx.require(n.normalize(t))}function r(n,t,r,u,f){var e=!1;return t||i("../AI/ME/MetricsProvider/BackendProviders/Legacy.Provider").then((function(t){var i=new t.LegacyProvider(r,u,f);return n.resolve(i),e=!0})),e}Object.defineProperty(t,"__esModule",{value:!0});t.loadLegacyProvider=t.dynamicImport=void 0;t.dynamicImport=i;t.loadLegacyProvider=r}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/AppInsight.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/Draft/DraftMetadataUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/AiArmKusto.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider"],(function(n,t,i,r,u,f,e,o,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.AppInsightProvider=void 0;var h="Please define dynamicImport for dynamic loading",c=(function(){function n(n,t,i){this.id=3;this._draftProviderDefer=Q.defer();this._liveProviderDefer=Q.defer();this._resourceDefinition=n;this._ajaxHelper=t;this._telemetryContext=i;var e=f.isHostedInsideIbiza();u.isResourceDefinition(this._resourceDefinition)&&(this._useDraftDemoAppId=!e||this._resourceDefinition.id===r.DraftDEMOAPPAppId,this._useDraftDemoAppId&&(this._resourceDefinition={id:r.DraftDEMOAPPAppId},this._loadDraftProvider()),this._kustoProvider=new o.AiArmKustoProvider(this._resourceDefinition,t,i));this._mdmProvider=new s.MdmV2Provider(n,t,i)}return n.prototype.getNamespaces=function(n,t){var i=[{name:r.AIKustoNamespace,category:r.NamespaceOptionType.Standard}];return this._useDraftDemoAppId?Q(i):this._mdmProvider.getNamespaces(n,t).then((function(n){var t=i;return t.concat(n||[])}))},n.prototype.getMetricDefinitions=function(n,t,i){var o,s,h,c;return this._useDraftDemoAppId?this._draftProviderDefer.promise.then((function(u){return u.getMetricDefinitions(n,t,i).then((function(n){return n.forEach((function(n){n.metricId.namespace={name:r.AIKustoNamespace}})),n}))})):(o=[],s=u.isResourceDefinition(this._resourceDefinition)&&this._resourceDefinition.id===r.DraftDEMOAPPAppId,(s||t===r.AIKustoNamespace)&&(h=this._kustoProvider.getMetricDefinitions(n,t,i).then((function(n){return n.forEach((function(n){n.metricId.namespace={name:r.AIKustoNamespace}})),n})),o.push(h)),this._resourceDefinition&&!s&&t!==r.AIKustoNamespace&&(c=this._mdmProvider.getMetricDefinitions(n,t,i).then((function(n){return n.forEach((function(n){n.metricId.namespace||(n.metricId.namespace={name:r.ResourceTypes.ApplicationInsights});n.category={id:e.getDraftCategoryName(n.metricId.name.id,!1)}})),n})),o.push(c)),f.joinAggregatePromises(o))},n.prototype.getDimensionDefinitions=function(n,t,i){var u=n.filter((function(n){return n.namespace===r.AIKustoNamespace})),e,o;return this._useDraftDemoAppId?this._draftProviderDefer.promise.then((function(n){return n.getDimensionDefinitions(u,t,i)})):(e=[],u&&u.length>0&&e.push(this._kustoProvider.getDimensionDefinitions(u,t,i)),o=n.filter((function(n){return n.namespace!==r.AIKustoNamespace})),o&&o.length>0&&e.push(this._mdmProvider.getDimensionDefinitions(o,t,i)),f.joinAggregatePromises(e))},n.prototype.getDimensionValues=function(n,t,i,u,e,o){var s=n.filter((function(n){return n.namespace===r.AIKustoNamespace})),h,c;return this._useDraftDemoAppId?this._draftProviderDefer.promise.then((function(n){return n.getDimensionValues(s,t,i,u,e,o)})):(h=[],s&&s.length>0&&h.push(this._kustoProvider.getDimensionValues(s,t,i,u,e,o)),c=n.filter((function(n){return n.namespace!==r.AIKustoNamespace})),c&&c.length>0&&h.push(this._mdmProvider.getDimensionValues(c,t,i,u,e,o)),f.joinAggregatePromises(h))},n.prototype.getMetricResults=function(n,t){var i=n.metrics,e,s,u,o;return!i||i.length===0?Q([]):(e=i.filter((function(n){return n.namespace===r.AIKustoNamespace||!n.crossResource&&n.resourceId===r.DraftDEMOAPPAppId})),n.metrics=e||[],this._useDraftDemoAppId?this._draftProviderDefer.promise.then((function(i){return i.getMetricResults(n,t)})):i[0]&&i[0].namespace===r.AILiveNamespace?(s=i.filter((function(n){return n.namespace===r.AILiveNamespace})),n.metrics=s,this._loadLiveProvider(),this._liveProviderDefer.promise.then((function(i){return i.getMetricResults(n,t)}))):(u=[],e.length>0&&u.push(this._kustoProvider.getMetricResults(n,t)),o=i.filter((function(n){return n.crossResource||n.resourceId!==r.DraftDEMOAPPAppId&&(!n.namespace||n.namespace!==r.AILiveNamespace&&n.namespace!==r.AIKustoNamespace)})),o.length>0&&(n.metrics=o,u.push(this._mdmProvider.getMetricResults(n,t))),f.joinAggregatePromises(u)))},n.prototype._loadLiveProvider=function(){var n=this;i.dynamicImport&&typeof i.dynamicImport=="function"?this._liveProviderCreated||i.dynamicImport("../AI/ME/MetricsProvider/BackendProviders/AiLive.Provider").then((function(t){var i=new t.AiLiveProvider(n._resourceDefinition,n._ajaxHelper,n._telemetryContext);n._liveProviderDefer.resolve(i);n._liveProviderCreated=!0})):this._liveProviderDefer.reject(h)},n.prototype._loadDraftProvider=function(){var n=this;i.dynamicImport&&typeof i.dynamicImport=="function"?this._draftProviderCreated||i.dynamicImport("../AI/ME/MetricsProvider/BackendProviders/Dummy.Provider").then((function(t){var i=new t.DummyProvider;n._draftProviderDefer.resolve(i);n._draftProviderCreated=!0;n._ajaxHelper.initialAjaxSentDefer.promise.isFulfilled()||n._ajaxHelper.initialAjaxSentDefer.resolve(!0)})):this._draftProviderDefer.reject(h)},n})();t.AppInsightProvider=c}))