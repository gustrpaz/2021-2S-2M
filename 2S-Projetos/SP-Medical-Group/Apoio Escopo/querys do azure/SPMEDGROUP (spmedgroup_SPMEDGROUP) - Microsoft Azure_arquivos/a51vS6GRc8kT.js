define("MsPortalImpl/Services/SubsCreditCheck",["require","exports","MsPortalImpl/Resources/ImplScriptResources","MsPortalFx/Globalization","FxHubs/Internal.Constants"],(function(n,t,i,r,u){"use strict";function f(n){return n===0||n==="0"?!1:!n}function h(n){((n===null||n===void 0?void 0:n.jqXHR)||{}).status!==0&&e.trace({source:"SubscriptionCreditCheck",action:"CheckRemainingCredit",actionModifier:"CriticalQueryFailure",data:{error:MsPortalFx.getLogFriendlyMessage(n)}})}function w(n){if(!n.error)return!0;e.trace({source:"SubscriptionCreditCheck",action:"CheckRemainingCredit",actionModifier:"GracefulErrors",data:{error:MsPortalFx.getLogFriendlyMessage(n.error)}})}function b(n){var t=n||{},i=t.currency,o=t.error,r=t.remaining,s=t.showUpgradeNotification,u=t.subscriptionId,h=t.total;return!n||f(i)||f(r)||!u?(e.trace({source:"SubscriptionCreditCheck",action:"InvalidBillingCreditResponseFormat",data:{currency:!f(i),error:o,remaining:!f(r),showUpgradeNotification:s,subscriptionId:u,total:!f(h)}}),!1):!0}function k(n){var e=s&&s.remainingCreditEndpoint,f,o;n.length&&e&&(f=n.filter((function(n){return!!(n.subscriptionPolicies&&n.subscriptionPolicies.quotaId)&&!!~["active","enabled","pastdue",].indexOf(u.subscriptionStatusMap[(n.state||"").toLowerCase()])})).map((function(n){return{subscriptionId:n.subscriptionId,quotaId:n.subscriptionPolicies.quotaId}})).slice(0,100),f.length&&(o=MsPortalFx.extendArrayIntoMap({},n,(function(n){return n.subscriptionId}),(function(n){return n.displayName})),a.ajax({uri:e,type:"POST",data:JSON.stringify(f),contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){var u=(Array.isArray(n)?n:[]).filter(w).filter(b);u.length<=p&&u.forEach((function(n){var f=r.NumberFormat.create({style:"currency",currency:n.currency,currencyDisplay:"symbol"}),u=f.format(n.remaining),t=i.subRemCredit.format(o[n.subscriptionId],u);n.showUpgradeNotification&&(t=t+("<br/><br/><a href='#blade/Microsoft_Azure_Billing/SubscriptionUpgradeBlade/azureSubscriptionId/"+n.subscriptionId+"/appId/HubsExtensionRemCreditNotification'>"+MsPortalFx.encodeHtml(i.subUpgrade)+"<\/a>"));y.publish({title:i.subRemCreditTitle.format(u),description:t,descriptionAsHtml:!0,status:v.Information,uri:"#resource/subscriptions/"+n.subscriptionId})}));t.subscriptionsRequiringUpgrade(u.filter((function(n){return n.showUpgradeNotification})))}),(function(n){return h(n)})).catch((function(n){return h(n)}))))}Object.defineProperty(t,"__esModule",{value:!0});t.DEV=t.subscriptionsRequiringUpgrade=t.checkRemainingCredit=void 0;var c=MsPortalFx.Base,l=c.Diagnostics,e=l.Telemetry,a=MsPortalFx.Base.Net2,o=MsPortalFx.Hubs.Notifications,v=o.NotificationStatus,y=o.ClientNotification,p=3,s=MsPortalFx.getEnvironmentValue("links");t.checkRemainingCredit=k;t.subscriptionsRequiringUpgrade=ko.observable([])}))