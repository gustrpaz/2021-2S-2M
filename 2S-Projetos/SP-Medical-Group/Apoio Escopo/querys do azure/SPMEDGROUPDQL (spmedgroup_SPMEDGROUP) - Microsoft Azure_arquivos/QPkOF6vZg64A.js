define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/MdmResponseParser",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Telemetry","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/MdmInterfaces"],(function(n,t,i,r,u,f){"use strict";function o(n,t,i,u,e,o){var c=[];return!t||t.length<1?(r.logWarning("MdmResponseParser.getParsedResults",n.telemetryContext,{ErrorMessage:"No metrics"}),c):(t.forEach((function(t){var y=e.filter((function(n){if(n.name.value.toLowerCase()===t.name.toLowerCase())return t.aggregation||(t.aggregation=h(n)),!0}))[0],r=o.filter((function(n){return n.name.value.toLowerCase()===t.name.toLowerCase()}))[0],a,l,v;r&&(a=s(y,r,i,u&&u.dimensionId,t.aggregation),l=r.name,t.name=l.value,v={metric:t,startTime:n.timespan.startTime,endTime:n.timespan.endTime,timeGrain:n.timegrain,data:a,timeRangeExtended:n.extendedTimespan,displayName:l.localizedValue,unit:f.getMetricUnit(r.unit,"MdmV2Provider",n.resourceId,l.value)},c.push(v))})),c)}function s(n,t,r,f,o){var h=[],c=t.timeseries,l,s;if(c)for(l=function(t){var v=c[t],s=v.metadatavalues,y=s&&s.length>0,d=n&&(y?u.find(n.timeseries,(function(n){return n.metadatavalues[0].value.toLowerCase()===v.metadatavalues[0].value.toLowerCase()})):n.timeseries[t]),g=e(d&&d.data,o),p=e(v.data,o),nt=p&&p[0]&&p[0].value,a=y?[{key:s[0].name.value,value:s[0].value}]:null,w,tt;if(a&&(w=i.getResourceName(s[0].value),w!==s[0].value&&(a[0].displayName=w)),tt=r&&f&&r.filter((function(n){return n.dimensionId.toLowerCase()===f.toLowerCase()})).length===1,y&&tt){var l=r.filter((function(n){return n&&n.dimensionId&&n.dimensionId.toLowerCase()===f.toLowerCase()}))[0],b=l.value&&l.value.length&&l.value.map((function(n){return n.toLowerCase()})),k=s[0].value&&s[0].value.toLowerCase(),it=l.operator===1?b.indexOf(k)===-1:l.operator===3?b.some((function(n){return k.indexOf(n)===0})):b.indexOf(k)!==-1;it&&h.push({dataPoints:g,summary:nt,segment:a})}else h.push({dataPoints:g,summary:nt,segment:a})},s=0;s<c.length;s++)l(s);return h}function e(n,t){var i=[];return n&&n.forEach((function(n){if(n){var r=n[f.getAggrString(t)];r===null||r===undefined||isNaN(r)||i.push({timestamp:new Date(n.timeStamp),value:r})}})),i}function h(n){var t=n.timeseries,r=t&&t[0]&&t[0].data&&t[0].data[0]&&Object.keys(t[0].data[0]).filter((function(n){return n!=="timeStamp"})),i=r&&r[0];return i?(i=i.charAt(0).toUpperCase()+i.slice(1),f.MDMaggregationMap[i]||7):0}Object.defineProperty(t,"__esModule",{value:!0});t.getParsedResults=void 0;t.getParsedResults=o}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/MappedUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Telemetry","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/TimeUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/MdmInterfaces","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/MdmResponseParser"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function kt(n,t){var i=c,u=n.lastIndexOf("#"),e=encodeURI(n.substring(0,u)),f=n.substr(u+1,n.length);return t.forEach((function(n,t){n&&(t!==0&&(i+=f===r.notEqualsString?" and ":" or "),i+=e+" "+f+" '"+encodeURI(n)+"'")})),i}function p(n){var t=[];return n.dimensions&&n.dimensions.forEach((function(n){n&&t.push({dimensionName:{id:n.value,displayName:n.localizedValue||n.value},supportedOperators:it,multiSelectNonSupportedOpList:rt})})),t}function dt(n,t){var i=[];return t&&n.forEach((function(n){t.some((function(t){return t.name.value===n.name&&t.dimensions?(i=p(t).concat(i),!0):!1}))})),i}function gt(n){var t=[];return n&&n.forEach((function(n){n&&n.timeseries&&n.timeseries.forEach((function(n){var i=n.metadatavalues;i&&i.forEach((function(n){var r={value:n.value},i;n.name.value.toLowerCase()==="microsoft.resourceid"&&(i=f.getResourceName(n.value),i!==n.value&&(r.displayName=i));t.push(r)}))}))})),t}function ni(n,t){var i=n.metricAvailabilities;return i&&i.length>0?i.map((function(n){return n.timeGrain})):(u.logWarning("MDMV2Provider: Timegrains are not specified for this metric",t,{Metric:n.name.value}),s.allSupportedTimegrains)}Object.defineProperty(t,"__esModule",{value:!0});t.MetricResultsUrlBuilder=t.MdmV2Provider=void 0;var w="api-version="+(i.getFeatureValue("metricapiversion")||"2019-07-01"),b="api-version=2018-01-01",v="api-version=2017-12-01-preview",k="/providers/microsoft.insights/metricdefinitions?",d="/providers/microsoft.insights/metricNamespaces?api-version=2017-12-01-preview",g=26784e5,nt="metricNamespace=",l="region=",tt="/subscriptions/",it=[0,1,3],rt=[3],ut=(function(){function n(n,t,i){this.id=10;this._serverMetricDefs={};this._mdCache={};this._resDef=n;f.isResourceDefinition(n)?(this._resId=n.id,this._defaultNamespace=f.getResourceProvider(this._resId),this._isCrossRes=!1):(this._resId=tt+(n.subscription&&n.subscription.subscriptionId),this._defaultNamespace=n.resourceType,this._region=n.region,this._isCrossRes=!0);this._resId=o.replaceAll(this._resId,"#","%23");this._ajax=t;this._telemetry=i}return n.prototype.getNamespaces=function(n,t){var i=this,f,e;return this._nsCache&&!this._nsCache.isRejected()&&!t?this._nsCache:(f=this._resId+d,this._isCrossRes&&(f+="&"+l+this._region),e=this._ajax.fetchArmCollection(f,this._resId,r.QueryNames.MDMV2Namespace,n).then((function(n){var t=[];return n.length>0?n.forEach((function(n){if(n.properties){var u=n.properties.metricNamespaceName.toLowerCase();(i._isCrossRes&&u===i._defaultNamespace||!i._isCrossRes)&&t.push({name:u,category:u===i._defaultNamespace?r.NamespaceOptionType.Standard:r.NamespaceOptionType.Custom})}})):t.push({name:i._defaultNamespace,category:r.NamespaceOptionType.Standard}),t})).catch((function(){return u.logWarning("getNamespaces failed for this RP",i._telemetry,{ResourceId:i._resId,ResourceType:i._defaultNamespace}),[{name:i._defaultNamespace,category:r.NamespaceOptionType.Standard}]})),this._nsCache=e,e)},n.prototype.getMetricDefinitions=function(n,t,r){var o=this,u=t||this._defaultNamespace,s=(this._isCrossRes?this._resId+"-"+this._region+"-":c)+u,f=this._mdCache[s],e;return!f||f.isRejected()||r?(e=this._getServerMetricDefinitions(u,n,r).then((function(n){return o._transformMetricDefinitions(n,u)})),this._mdCache[s]=e,e):!this._isCrossRes&&i.getStaticMetricDefinitionFile(this._defaultNamespace,u)?f.then((function(n){return n.forEach((function(n){n.metricId.resourceDefinition=o._resDef})),n})):f},n.prototype.getDimensionDefinitions=function(n,t,i){var u=this,r;return!n||n.length===0?Q([]):(r=[],n.forEach((function(f){r.push(u._getServerMetricDefinitions(f.namespace||u._defaultNamespace,t,i).then((function(t){return dt(n,t)})))})),o.joinAggregatePromises(r))},n.prototype.getDimensionValues=function(n,t,u,f,e,s){var l=this,h,c;return!n||n.length===0||!t||!e?Q([]):(h=new a(this._resId,this._region).setResultType(y).setStartEndTime(e.startTime,e.endTime),this._isCrossRes&&h.setNamespace(this._defaultNamespace),u&&u.forEach((function(n){h.addFilter(n)})),h.addFilter({dimensionId:i.encodeDimension(t),operator:0,value:["*"]}),c=[],n.forEach((function(n){var t,i;h.clearMetrics().addMetric(n.name);t=n.namespace;t&&h.setNamespace(t);i=l._ajax.fetchArmCollection(h.buildUrl(),l._resId,r.QueryNames.MDMV2DimensionValue,s).then((function(n){return gt(n)}));c.push(i)})),o.joinAggregatePromises(c))},n.prototype.getMetricResults=function(n,t){var f=this,v=n.metrics,y=n.filters,s=n.splitBy,c=n.timerange,b=n.timegrain,u,p,w;if(!v||v.length===0||!c)return Q([]);var l=e.expandTimespan(c,b,n.isRelativeTime),d=l.endTime.getTime()-l.startTime.getTime(),k=d<=g;return k||(l=c),u=new a(this._resId,this._region,this._telemetry).setTimeGrain(b),this._isCrossRes&&u.setNamespace(this._defaultNamespace),y&&y.length>0&&(y.forEach((function(n){n&&(n.dimensionId=i.encodeDimension(n.dimensionId),n.value=n.value.map((function(n){return i.encodeDimension(n)})),u.addFilter(n))})),s&&u.setTopAndSort(s.top,s.sort)),p=s&&s.dimensionId,v.length===1&&p&&(u.addFilter({dimensionId:p,operator:0,value:["*"]},!0),u.setTopAndSort(s.top,s.sort)),w=[],v.forEach((function(i){var a,b;u.clearMetrics().addMetric(i.name).setAggregation(i.aggregation);a=i.namespace&&i.namespace;a&&u.setNamespace(a);var e=[],p=u.buildFilterString(),o=p?'{"filter": "'+p+'" }':undefined;u.setStartEndTime(c.startTime,c.endTime);f._isCrossRes&&o?e.push(f._ajax.fetchArm(u.buildUrl(null,!0,!0),f._resId,r.QueryNames.MDMVV2SummaryResult,t,"POST",o)):e.push(f._ajax.fetchArm(u.buildUrl(null,!0),f._resId,r.QueryNames.MDMVV2SummaryResult,t));(!n.fetchDataKind||n.fetchDataKind&5)&&(u.setStartEndTime(l.startTime,l.endTime),f._isCrossRes&&o?e.push(f._ajax.fetchArm(u.buildUrl(null,!1,!0),f._resId,r.QueryNames.MDMV2MetricResult,t,"POST",o)):e.push(f._ajax.fetchArm(u.buildUrl(null,!1),f._resId,r.QueryNames.MDMV2MetricResult,t)));b=Q.spread(e,(function(n,t){if(n)return h.getParsedResults({resourceId:i.resourceId,timespan:c,timegrain:t&&t.interval,extendedTimespan:k?l:undefined,telemetryContext:f._telemetry},v,y,s,t&&t.value||[],n.value||[])}));w.push(b)})),o.joinAggregatePromises(w)},n.prototype._getServerMetricDefinitions=function(n,t,u){var h=(this._isCrossRes?this._resId+"-"+this._region+"-":c)+n,a=this._serverMetricDefs[h],o,s,e,f;return a&&!u?a:(o=this._resId+k,s=nt+n,o+=this._isCrossRes?""+l+this._region+"&"+s+"&"+v:s+"&"+b,e=void 0,f=i.getStaticMetricDefinitionFile(this._defaultNamespace,n),this._isCrossRes||!f||u?e=this._ajax.fetchArmCollection(o,this._resId,r.QueryNames.MDMV2Metadata,t):(f.cachedMetricDef||(f.cachedMetricDef=this._ajax.fetchStaticFile(f.filepath,{resourceId:this._resId,queryName:r.QueryNames.StaticMetadata},t)),e=f.cachedMetricDef),this._serverMetricDefs[h]=e,e)},n.prototype._transformMetricDefinitions=function(n,t){var h=[],e,i,r,c,o,l;if(!n)return h;for(e=0;e<n.length;e++)if(i=n[e],r=i.name.value,i.isDimensionRequired)c=!this._isCrossRes&&f.getResourceProvider(this._resId),u.logWarning("Property isDimensionRequired is set for this metric/resource.",this._telemetry,{ResourceId:this._resId,ResourceType:c,Metric:r});else{o=void 0;i.supportedAggregationTypes?(l=i.supportedAggregationTypes.map((function(n){return s.MDMaggregationMap[n]||7})),o=l.filter((function(n,t,i){return i.indexOf(n)===t}))):o=s.allMDMMetricAggregationTypes;var v=p(i).map((function(n){return n.dimensionName.id})),a=t||i.namespace,y={metricId:{resourceDefinition:this._resDef,name:{id:r,displayName:i.name.localizedValue||r},namespace:{name:a&&a.toLowerCase()}},defaultAggregation:s.MDMaggregationMap[i.primaryAggregationType]||7,supportedAggregations:o,unit:s.getMetricUnit(i.unit,"MdmV2Provider",i.resourceId,r),supportedTimegrains:ni(i,this._telemetry),category:{id:i.category,displayName:i.category},supportedGroupBy:v,description:i.displayDescription};h.push(y)}return h},n})();t.MdmV2Provider=ut;var ft="timespan=",et="&interval=",ot="&metricnames=",st="&metricNamespace=",ht="&aggregation=",ct="&top=",lt="&orderby=",at="&$filter=",vt="&rollupby=",yt="&resulttype=metadata",pt="&autoadjusttimegrain=true",wt="&validatedimensions=false",y="metadata",bt="data",c="",a=(function(){function n(n,t,i){this.reset();this._baseUrl=n+"/providers/microsoft.Insights/metrics?";this._isCrossResource=!!t;this._region=t;this._telemetryContext=i}return n.prototype.reset=function(){this._namespace=c;this._metricIds=[];this._aggregation=c;this._filters={};this._groupingDimension=c;this._top=r.UniqueDimensionValueThreshold;this._sortOrder="desc";this._startTime=null;this._endtime=null;this._timeGrain=c;this._baseUrl=c;this._resultType="data";this._isCrossResource=!1;this._region=c},n.prototype.setNamespace=function(n){return this._namespace=n,this},n.prototype.addMetric=function(n){return this._metricIds.indexOf(n)===-1&&this._metricIds.push(n),this},n.prototype.clearMetrics=function(){return this._metricIds=[],this},n.prototype.setAggregation=function(n){return this._aggregation=s.getAggrString(n),this},n.prototype.setBaseUrl=function(n){return this._baseUrl=n,this},n.prototype.addFilter=function(n,t){var f=n.operator===1?r.notEqualsString:n.operator===3?r.startsWithString:r.equalsString,i=n.dimensionId+"#"+f,u=this._filters[i];return t?(this._groupingDimension=n.dimensionId,this._filters[n.dimensionId+"#"+r.notEqualsString]||this._filters[n.dimensionId+"#"+r.startsWithString]||(this._filters[i]=u||n.value)):this._filters[i]=u?n.value.concat(u):n.value,this},n.prototype.setStartEndTime=function(n,t){return this._startTime=n,this._endtime=t,this},n.prototype.setTimeGrain=function(n){return this._timeGrain=n,this},n.prototype.setTopAndSort=function(n,t){return this._top=n||r.UniqueDimensionValueThreshold,this._sortOrder=t===1?"asc":"desc",this},n.prototype.setResultType=function(n){return this._resultType=n,this},n.prototype.buildUrl=function(n,t,i){var r,f,e,k;if(n=n||w,this._isValidMetricBuilderState()){var o=ft+this._startTime.toISOString()+"/"+this._endtime.toISOString(),s=ot+this._metricIds.map((function(n){return encodeURIComponent(n)})).join(),h=this._namespace?st+encodeURIComponent(this._namespace):c,u=c;if(this._isCrossResource&&(n=v,u="&"+l+this._region),this._resultType===y)return r=this._buildFilterExpression(),this._baseUrl+o+s+h+r+yt+"&"+n+u;f=this._timeGrain;e=pt;t&&(f="FULL",e=c);var d=et+f,g=this._aggregation?ht+this._aggregation:c,a=c,p=c,r=c,b=c;return Object.keys(this._filters).length>0&&(i||(r=this._buildFilterExpression()||r),b=this._buildRollupExpression(),a=ct+this._top,p=lt+(this._aggregation?this._aggregation+" ":c)+this._sortOrder),k=wt,this._baseUrl+o+d+s+g+h+a+p+r+b+e+k+"&"+n+u}},n.prototype._isValidMetricBuilderState=function(){var n=[],t,i;return this._startTime||n.push("No start time was provided."),this._endtime||n.push("No end time was provided."),this._timeGrain||this._resultType!==bt||n.push("No time grain was provided."),!this._isCrossResource||this._region&&this._namespace||n.push("No region and/or namespace was provided for cross resource query."),t=n.length>0,t&&(i="MultiDimMdm.buildURL: Cannot build metric result uri.",u.logError(i,this._telemetryContext,i,{Urls:n.toString()})),!t},n.prototype.buildFilterString=function(){var t=this,n;return Object.keys(this._filters).forEach((function(i){if(t._filters[i]&&t._filters[i].length>0){var r=kt(i,t._filters[i]);n=n?n+" and "+r:r}})),n},n.prototype._buildFilterExpression=function(){var n=this.buildFilterString();return n?at+n:n},n.prototype._buildRollupExpression=function(){var t=this,n;return Object.keys(this._filters).forEach((function(i){var u=i.lastIndexOf("#"),r=i.substring(0,u);t._groupingDimension!==r&&(n=n?n+","+encodeURIComponent(r):r)})),n?vt+n:c},n})();t.MetricResultsUrlBuilder=a}))