define("MsPortalImpl/Notifications/NotificationsAreaFunctions",["require","exports","MsPortalImpl/Services/Services.ArmEvents","MsPortalImpl/UI/Hubs/UI.NotificationManager","MsPortalImpl/Services/Services.AssetTypes"],(function(n,t,i,r,u){"use strict";function w(n,t){var i=t.map((function(n){var t=n.properties,i,r;if(t&&(i=it(t.level,n.status),i&&(r=t.description,r)))return{timestamp:n.timestamp,status:i,title:n.operationName,description:r,correlationIds:[n.correlationId],isServerEvent:!0,additionalProperties:{subscriptionId:t.subscriptionId},caller:n.caller}}));i=i.filter(MsPortalFx.notNullOrUndefined);i.forEach((function(n){n.notificationId||(n.notificationId=l.generateClientNotificationId())}));i&&i.length&&n.get(r.NotificationHandler).notificationsCallback({messageArg:i,diContainer:n,messageContext:{srcWindowId:e.Shell,callStack:null,destWindowId:e.Shell}})}function tt(n,i){var r=[],f=[],u;i.forEach((function(n){var t=n&&n.eventSource||{};(t.value||"").toLowerCase()===v?r.push(n):f.push(n)}));u=f.map(rt).filter((function(n){return!!n}));r.length&&t.handleRecommendationEvents(n,r);u.length&&t.handleServerEvents(n,ko.toJS(u))}function it(n,t){var i,r;return n?(i=k[(n||"").toLowerCase()],i===o&&t&&(t||"").toLowerCase()==="failed"&&(i=1),r=y!==o&&y<=i,!r)?null:i?s.Error:s.Warning:null}function rt(n){var t=n.operationName||f,i=n.resourceProviderName||f;if(t.value&&i.value){var r=n.status||f,u=n.subStatus||f,e=n.eventName||f,o=n.eventSource||f,s={operationName:t.value,source:i.value,assetId:n.resourceUri,status:r.value,subStatus:u.value,correlationId:n.correlationId,timestamp:n.eventTimestamp&&new Date(n.eventTimestamp),caller:n.caller,properties:{correlationId:n.correlationId,description:n.description,eventChannels:n.eventChannels,eventDataId:n.eventDataId,eventName:e.value,eventNameLocalized:e.localizedValue||"",eventSource:o.value,eventSourceLocalized:o.localizedValue,eventTimestamp:n.eventTimestamp,level:n.level,operationId:n.operationId,operationName:t.value,operationNameLocalized:t.localizedValue,resourceGroupName:n.resourceGroupName,resourceProviderName:i.value||"",resourceProviderNameLocalized:i.localizedValue||"",resourceUri:n.resourceUri,status:r.value,statusLocalized:r.localizedValue,submissionTimestamp:n.submissionTimestamp,subscriptionId:n.subscriptionId,subStatus:u.value||"",subStatusLocalized:u.localizedValue||""}};return d(n.properties,(function(n,t,i){i.hasOwnProperty(n)||(i[n]=t)}),s.properties),s}}var p;Object.defineProperty(t,"__esModule",{value:!0});t.setErrorLevel=t.showEventsNotifications=t.publishClientNotifications=t.handleServerEvents=t.handleRecommendationEvents=void 0;var h=MsPortalFx.Base,b=h.Diagnostics,e=h.Constants,c=MsPortalFx.Hubs.Notifications,l=c.ClientNotification,s=c.NotificationStatus,a="recommendationExpirationDate",v="recommendation",ut=b.createLog(n),o=undefined,k={warning:0,error:1,critical:2},d=MsPortalFx.forEachKey,f={localizedValue:o,value:o},g="Notifications.handleRecommendationEvents",y=1,nt=function(n,t){if(t&&t.length){var i=[],f=[];t.forEach((function(t){var r=t.operationName,e=t.resourceUri,o=t.properties,h;r&&t.description&&o&&o[a]&&e&&(h=new Date(t.properties[a]),h>=new Date&&f.push(n.get(u.AssetTypeService).mapResourceIdToDynamicSelectionAndIcon(e,g).then((function(n){var u=n.selection,f={},e=Object.keys(t.properties).filter((function(n){return n.startsWith(v)}));e.forEach((function(n){f[n]=t.properties[n]}));u.detailBladeInputs=u.detailBladeInputs||{};MsPortalFx.extend(u.detailBladeInputs,{referrerInfo:f});i.push({timestamp:new Date(t.eventTimestamp),status:s.Information,title:r.localizedValue||r.value,description:t.description,correlationIds:[t.correlationId],linkedBlade:u,isRecommendation:!0,additionalProperties:f,isServerEvent:!0,notificationId:l.generateClientNotificationId()})}),(function(){}))))}));Q.allSettled(f).then((function(){i&&i.length&&n.get(r.NotificationHandler).notificationsCallback({messageArg:i,diContainer:n,messageContext:{srcWindowId:e.Shell,callStack:null,destWindowId:e.Shell}})}))}};t.handleRecommendationEvents=nt;p=function(n,t){t&&t.length&&(n.get(r.NotificationManager).addServerEvents(t.slice(0,100)),w(n,t),n.get(i.ArmEvents).matchEvents(t))};t.handleServerEvents=p;t.publishClientNotifications=w;t.showEventsNotifications=tt}));
define("MsPortalImpl/Notifications/NotificationsFetchedFromClientHelper",["require","exports","FxHubs/ArmHelpers/ArmApisStartup","FxHubs/ArtHelpers/ArtApis","MsPortalImpl/Notifications/NotificationsAreaFunctions","MsPortalImpl/Services/Services.Settings","FxHubs/HubsSettingsSchema","MsPortalImpl/Services/Services.BrowserSettings"],(function(n,t,i,r,u,f,e,o){"use strict";function rt(){s.trace({source:"NotificationsFetchedFromClientHelper",action:"ServiceErrorFromArg"})}function ut(n,r){return n.map((function(n){var o=new Date,s,u,f,e,h;return r?s=w(n):(u=new Date,u.setMinutes(u.getMinutes()-t.defaultPollingInterval/6e4),s=u),f=ft(s,o,1),e=parseInt(MsPortalFx.getFeatureValue("eventsoverlapminutes")),e&&f.setMinutes(f.getMinutes()-(e>5?5:e)),h=i.getDigestEventsApi(n,f,o,r?"Category eq 'Recommendation'":nt,50),b(n,o),{uri:h,arrayResponse:!0,telemetry:"Notifications.load"}}))}function ft(n,t,i){n=n<t?n:t;var r=new Date(t.getTime());return r.setDate(r.getDate()-i),n<r?r:n}function et(n,i,r){var u=n.reason||{},f=FxImpl.Azure.buildSimplifiedError(n.reason||n),e=u.httpStatusCode,h=((u.content||{}).error||{}).code||f.code||"",o=JSON.stringify(f);if(e===0){a.verbose(o);r.pollingInterval=tt;return}if(ot(e,h)){var c=n.api,s=/\/subscriptions\/(.*?)\/.*/gi.exec(c);s&&MsPortalFx.remove(i,s[1]);r.pollingInterval=t.defaultPollingInterval}a.warning(o)}function ot(n,t){return!!~[401,403,404,410].indexOf(n)||n===400&&((t||"").toLowerCase()==="disallowedprovider"||(t||"").toLowerCase()==="disallowedoperation")}function st(n,i){return __awaiter(this,void 0,void 0,(function(){var r,u,e,o;return __generator(this,(function(s){switch(s.label){case 0:return r=n.get(f.SettingsManager),[4,f.readUserSettings(r,[p],null)];case 1:return u=s.sent(),e=MsPortalFx.convertArrayToMap(i,(function(n){return n.subscriptionId}),MsPortalFx.identity),o=g(u,(function(n,t,i){var r=Date.parse(t);!isNaN(r)&&e[n]&&(i[(n||"").toLowerCase()]=new Date(t))}),{}),t.lastFetchTimes=o,[2]}}))}))}function w(n){var i=t.lastFetchTimes||{},r;return i[n]||(r=new Date,r.setDate(r.getDate()-7),i[(n||"").toLowerCase()]=r),t.lastFetchTimes=i,i[n]}function ht(n,i){return __awaiter(this,void 0,void 0,(function(){var f,h,u,e,c,l=this;return __generator(this,(function(a){switch(a.label){case 0:if(f=s.start({source:"NotificationsFetchedFromClientHelper",action:"getServiceHealthAlerts"}),!(n===null||n===void 0?void 0:n.length)||!v)return s.completeTrace(f,{alertCount:0,subscriptionIdsCount:0,useArgToValidate:v}),[2,[]];a.label=1;case 1:return a.trys.push([1,3,,4]),h={query:t.serviceHealthAlertsQuery,subscriptions:n,options:{$top:1e3,resultFormat:"objectArray"}},[4,r.getDataFromArt(h,"NotificationsFetchedFromClientHelper.GetServiceHealthAlerts").catch((function(n){return __awaiter(l,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return((n===null||n===void 0?void 0:n.httpStatusCode)>=500)?[4,i.getAsync(o.ServiceDependencyState)]:[3,2];case 1:t.sent().azureResourceGraphUnavailable(!0);rt();t.label=2;case 2:return[2]}}))}))}))];case 2:return u=a.sent(),e=(u===null||u===void 0?void 0:u.data)||[],s.completeTrace(f,{alertCount:e.length,resultCount:u.count}),[2,e];case 3:return c=a.sent(),s.endTrace(f,"failure",{error:MsPortalFx.getLogFriendlyMessage(c)}),[3,4];case 4:return[2,[]]}}))}))}function ct(n,r){return __awaiter(this,void 0,void 0,(function(){var o,f,e,s,c=this;return __generator(this,(function(l){switch(l.label){case 0:return(h++,!r||!r.length)?[2]:(o=r.slice(0,100).map((function(n){return n.subscriptionId})),[4,st(n,r)]);case 1:return l.sent(),f=!0,e={pollingInterval:t.defaultPollingInterval},s=function(r){return __awaiter(c,void 0,void 0,(function(){var c,l,a,v;return __generator(this,(function(y){switch(y.label){case 0:if(r!==h)return[2];c=[];l=ut(o,f);f=!1;y.label=1;case 1:return y.trys.push([1,3,,4]),[4,i.callBatchWithContinuation(l,(function(n){c.push.apply(c,n);e.pollingInterval=t.defaultPollingInterval}),(function(n){et(n,o,e)}),!0)];case 2:return y.sent(),[3,4];case 3:return a=y.sent(),[3,4];case 4:if(r!==h)return[2];c.length&&f&&k(n);y.label=5;case 5:return y.trys.push([5,7,,8]),c.length&&u.showEventsNotifications(n,c),[4,Q.delay(e.pollingInterval)];case 6:return y.sent(),s(r),[3,8];case 7:return v=y.sent(),[3,8];case 8:return[2]}}))}))},s(h),[2]}}))}))}function b(n,i){if(n){var r=t.lastFetchTimes||{};r[(n||"").toLowerCase()]=i;t.lastFetchTimes=r}}function k(n){c||(c=setTimeout((function(){var i,r,u;c=null;i={};r=t.lastFetchTimes;r&&(i[p]=r);u=n.get(f.SettingsManager);f.writeUserSettings(u,i,null)}),it))}Object.defineProperty(t,"__esModule",{value:!0});t.DEV=t.writeLastFetchedRecommendationsTimesToUserSettings=t.setLastFetchedRecommendationsTime=t.startPollingForDigestEvents=t.getServiceHealthAlerts=t.getLastRecommendationsFetchTime=t.serviceHealthAlertsQuery=t.lastFetchTimes=t.defaultPollingInterval=void 0;var l=MsPortalFx.Base,d=l.Diagnostics,s=d.Telemetry,a=l.Diagnostics.createLog(n),g=MsPortalFx.forEachKey,v=MsPortalFx.isFeatureEnabled("argsubscriptions"),y=MsPortalFx.isFeatureEnabled("fasteventservice"),p=e.Keys.lastRecommendationsFetchTime,nt=undefined,tt=y?1e4:12e5,c,it=3e5,h=0;t.defaultPollingInterval=y?5e3:6e5;t.serviceHealthAlertsQuery='servicehealthresources\r\n| where type == "microsoft.resourcehealth/events"\r\n| project eventType = tostring(properties.EventType), status = properties.Status, description = properties.Title, trackingId = properties.TrackingId, summary = properties.Summary, priority = toint(properties.Priority), impactStartTime = properties.ImpactStartTime, impactMitigationTime = properties.ImpactMitigationTime, lastUpdateTime = properties.LastUpdateTime\r\n| where (eventType == "ServiceIssue" and status == "Active" and impactStartTime > ago(3d)) or (eventType == "SecurityAdvisory" and impactMitigationTime > now() and impactStartTime > ago(28d) and lastUpdateTime > ago(3d))\r\n| summarize arg_max(todatetime(lastUpdateTime), *) by eventType, priority\r\n| summarize arg_max(priority * -1, *) by eventType\r\n| project-away max_';t.getLastRecommendationsFetchTime=w;t.getServiceHealthAlerts=ht;t.startPollingForDigestEvents=ct;t.setLastFetchedRecommendationsTime=b;t.writeLastFetchedRecommendationsTimesToUserSettings=k}))