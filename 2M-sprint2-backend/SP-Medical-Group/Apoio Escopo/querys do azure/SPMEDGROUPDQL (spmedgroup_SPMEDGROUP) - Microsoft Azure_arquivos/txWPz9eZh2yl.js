define("MsPortalImpl/Commands/FileDownloadUtil",["require","exports","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Hubs/UI.NotificationManager"],(function(n,t,i,r){"use strict";function e(n,t){(t.showDownloadProgressDialog&&t.showDownloadProgressDialog()||t.showUriCallbackConfirmationDialog&&t.showUriCallbackConfirmationDialog())&&n.dismissOpenDialog()}function b(n){var t=(n.httpMethod&&n.httpMethod()||"GET").toUpperCase();return t!=="GET"&&t!=="POST"?null:t}function k(n,t,i){var u=v(n),r={uri:t,type:i,dataType:u,headers:it(n),checkVersion:!1};return u==="binary"&&(r.processData=!1,r.responseType="arraybuffer"),i==="POST"&&n.httpRequestContent&&!!n.httpRequestContent()&&(r.data=n.httpRequestContent(),r.contentType=n.httpRequestContentType&&n.httpRequestContentType()||"application/json"),r}function d(n,i,r){var s=n.targetFileName()||u.defaultFileName,f=ut(n,i,r);e(i,n);f!==null&&(t.saveAsDlg(f,s),o(n,"success",200))}function s(n,i,r,f,o){e(i,n);t.notifyError(n,f,u.downloadErrorDetails.format(n.errorMessage&&n.errorMessage()||u.downloadError,r,f,o))}function g(n,i,r,u,f){var s=new Blob([r],{type:"application/octet-stream"});return e(i,n),t.saveAsDlg(s,h(n,f)),o(n,u,f.status),Q()}function h(n,t){return n.targetFileName&&n.targetFileName()?n.targetFileName():c(t)}function c(n){var r=n.getResponseHeader("Content-Disposition"),t=null,f=0,i;return r&&(i=MsPortalFx.find(r.split(";"),(function(n){return n.indexOf("filename")>=0})),i&&i.length>0&&(f=i.indexOf("="))>=0&&(t=i.substring(f+1),t&&(t=MsPortalFx.replaceAll(t,'"',"").trim()))),t||u.defaultFileName}function l(n,t){var r=n.split(","),o="text/plain",i,e,s,f;if(r.length>1&&r[1])if(o=rt(r),t==="binary")try{for(i=atob(r[1]),s=new Uint8Array(new ArrayBuffer(i.length)),f=0;f<i.length;f++)s[f]=i.charCodeAt(f);return{blob:new Blob([s],{type:o})}}catch(h){e=u.dataUriBinaryEncodingError}else try{return i=decodeURIComponent(r[1]),{blob:new Blob([i],{type:o})}}catch(h){e=u.dataUriTextEncodingError}else e=u.dataUriParseError;return{blob:null,errorMessage:e}}function nt(n,t){if(f.navigator.msSaveOrOpenBlob)f.navigator.msSaveOrOpenBlob(n,t);else{var r=(f.webkitURL||f.URL).createObjectURL(n),i=FxImpl.createElement("a");i.style.display="none";i.href=r;i.download=t;document.body.appendChild(i);i.click();setTimeout((function(){f.URL.revokeObjectURL(r);$(i).remove()}),2e4)}}function tt(n,t,i){o(n,"error",t,i);r.getNotificationManager().addClientNotification({title:u.downloadCommandError,description:i,status:y.Error,timestamp:new Date})}function a(n){return n.headers&&n.headers()?MsPortalFx.clone(n.headers()):null}function it(n){var i=n.authorizationToken&&n.authorizationToken(),t;return i?(t=a(n)||{},t.Authorization=i,t):a(n)}function v(n){var t=n.downloadType&&n.downloadType();return t===2?"binary":"text"}function rt(n){var r="text/plain",t,i;return n.length>0&&n[0]&&(t=n[0].split(":"),t.length>1&&t[1]&&(i=t[1].split(";"),i.length>0&&i[0]&&(r=i[0]))),r}function ut(n,t,i){var r=l(i,v(n));return r.errorMessage||!r.blob?(s(n,t,u.dataUriErrorStatusText,400,r.errorMessage),null):r.blob}function o(n,t,i,r){var u=new w.Status(t,i,r);n.downloadStatus(u);n.onEnd&&n.onEnd(u)}Object.defineProperty(t,"__esModule",{value:!0});t.convertDataUriToBlob=t.getContentDispostionOrDefaultFileName=t.getFilename=t.onSuccess=t.onError=t.dataUriHandler=t.getAjaxOptions=t.getHttpMethod=t.dismissDialog=t.notifyError=t.saveAsDlg=void 0;var y=MsPortalFx.Hubs.Notifications.NotificationStatus,p=MsPortalFx.ViewModels,w=p.FileDownload,f=window,u=i.FileDownloadCommand;t.saveAsDlg=nt;t.notifyError=tt;t.dismissDialog=e;t.getHttpMethod=b;t.getAjaxOptions=k;t.dataUriHandler=d;t.onError=s;t.onSuccess=g;t.getFilename=h;t.getContentDispostionOrDefaultFileName=c;t.convertDataUriToBlob=l}))