define("MsPortalImpl/UI/Commands/UI.CommandBarManager",["require","exports","FxInternal/Composition/ViewModel","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Extension/DefinitionCache","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/UI/Compositions/UI.Composition.Selectable2Registrar","MsPortalImpl/Base/Base.Selectable2"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function l(n,t,i,r){var e=ko.observable([]),o=ko.observable([]),s;return n.registerForDispose((function(){e().forEach(c);o().forEach(c)})),s=f.getCommandGroupForDefinitionItem(i.get(u.DefinitionCache),t.extension.name,t.bladeDefinition),s.then((function(u){u?a(n,t,i,u,r,e):v(n,t,i,o);ko.reactor(n,(function(){var n=u?e():o();t.widget.options.commandBar.items(n.slice())}))}))}function a(n,t,i,r,u,e){var h=t.widget,s=[],l=r.commands.map((function(r){var e=new f.ExtensionCommandMenuItemImpl(n,t.extension,t,r,t.bladeDefinition,i,u);return e.activate(),s.push(e),new o.PdlCommandButton(n,e)})),c=h.options.contextMenu.menuItems;c.push.apply(c,s);h.options.commandBar.menuItems(s);e(l)}function v(t,u,f,o){var y=u.bladeDefinition.toolbar,a=y?y.source.valuesFrom[0]:null,c,l,v;a&&(c=MsPortalFx.find(MsPortalFx.mapMany(u.children,(function(n){return n.children})),(function(n){return n.locator.name===a.part})),v=ko.observable(!0),u.uiBlockers.push(v),c.await(6).then((function(){var f=c.getViewModel(0),y=e.getModelValue(f,a.property),v,p;y.exists?(h.setSelectableContext(t.createChildLifetime(),f,u.widget.element),u.widget.options.renderCmdBarWhenNoCmd(!0),v=y.value.items,MsPortalFx.isObservableArray(v)?v.subscribeAndRun(t,(function(n){s.registerOpenBladeCommands(n,f,c,"commandBar2Selectables",undefined)?o(n):o([])})):l="Invalid view model for the toolbar at '{0}' in part '{1}'. It is missing the items property"):i.isV2(f.content())||(l="Unable to find the view model for the toolbar at '{0}' in part '{1}'.");l&&(l=l.format(a.property,c.locator.toFriendlyString()),p=FxImpl.createError(l),r.logToExtension(n,c.extension.name,2,p))})).finally((function(){return v(!1)})))}Object.defineProperty(t,"__esModule",{value:!0});t.create=void 0;var y=MsPortalFx.Base.Diagnostics,c=MsPortalFx.disposeDisposable;t.create=l}));
define("MsPortalImpl/UI/Commands/UI.Commands.Blade",["require","exports","FxInternal/AsyncLoader","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.ShellCommands","MsPortalImpl/UI/Commands/Base.PortalFunctions"],(function(n,t,i,r,u,f,e){"use strict";function nt(n,t){return o||(s=s||new FxImpl.TriggerableLifetimeManager,o=[],o[a]=new c(s,n,h.bladeRestore,a),o[v]=new c(s,n,h.bladeMaximize,v)),o[t]}function tt(n){o&&(s&&s.dispose(),o=null);o=n}var p,c,s,a,v,o,w;Object.defineProperty(t,"__esModule",{value:!0});t.ResetLayout=t.setDisplayStateCommands=t.getDisplayStateCommand=t.BladeDisplayStateCommand=t.Edit=t.Pin=void 0;var l=MsPortalFx.Base.Images,b=MsPortalFx.Blades,k=b.Internal.DisplayState,h=r.ShellCommands,y="Blade",d=function(){return MsPortalFx.require("MsPortalImpl/UI/Dx/UI.Editor")},g=(function(n){function t(t,i){return n.call(this,t,i,f.CommandNames.PinBlade,{text:h.pinToStartboard,icon:l.Pin()})||this}return __extends(t,n),t.prototype.execute=function(t){var r=this,u=this._getComposition();return u.getPinOptions().then((function(n){return MsPortalFx.isFeatureEnabled("dashboardnewpinexperience")?i.get("MsPortalImpl/UI/Dashboard/Common/DashboardPinHelper","pinTilesWithDashboardSelection").then((function(t){return t(r._diContainer,y,n)})):r._diContainer.get(e.PinBladePortalFunc).invoke(n,y)})).finally((function(){n.prototype.execute.call(r,t)}))},t})(f.ShellCommand);t.Pin=g;p=(function(n){function t(t,i,r){var u=n.call(this,t,i,f.CommandNames.EditBlade,{text:h.editBlade,icon:l.Edit()})||this;return u._lifetimeManager=t,u._onModeChanged=r,u}return __extends(t,n),t.prototype.execute=function(t){return __awaiter(this,void 0,void 0,(function(){var i,r;return __generator(this,(function(u){switch(u.label){case 0:return!this._editor?[4,d()]:[3,2];case 1:i=u.sent();this._editor=new i.Editor(this._diContainer);this._lifetimeManager.registerForDispose(this._editor);u.label=2;case 2:return this._editing?this._editor.save():(r=this._getComposition(),this._editor.injectIntoBlade(r)),this._changeMode(!this._editing),n.prototype.execute.call(this,t),[2]}}))}))},t.prototype.reset=function(){this._editor&&(this._changeMode(!1),this._editor.disableRegions())},t.prototype._changeMode=function(n){this._editing=n;this._onModeChanged(n)},t})(f.ShellCommand);t.Edit=p;c=(function(n){function t(t,i,r,u){var e=n.call(this,t,i,f.CommandNames.BladeDisplayState+k[u],{text:r})||this;return e.targetState=u,e}return __extends(t,n),t.prototype.execute=function(t){var i=u.getBladeContainerWidget($(this._currentContext.target));i&&i.options.displayState(this.targetState);n.prototype.execute.call(this,t)},t.prototype.bind=function(t){var i=u.getBladeContainerWidget($(t.target));n.prototype.bind.call(this,t);this.enabled(i&&this.targetState===i.options.displayState())},t})(f.ShellCommand);t.BladeDisplayStateCommand=c;a=1;v=2;t.getDisplayStateCommand=nt;t.setDisplayStateCommands=tt;w=(function(n){function t(t,i,r,u){var e=n.call(this,t,i,f.CommandNames.ResetLayout,{text:h.resetLayout,icon:l.Refresh(),enabled:r!==!0})||this;return e.bind=function(t){n.prototype.bind.call(e,t);e.enabled(r!==!0&&u()!==0)},e}return __extends(t,n),t.prototype.execute=function(t){this._getComposition().resetLayout();n.prototype.execute.call(this,t)},t.prototype.bind=function(){},t})(f.ShellCommand);t.ResetLayout=w}));
define("MsPortalImpl/UI/Compositions/UI.Composition.BladeTelemetry",["require","exports","Fx/DependencyInjection","MsPortalImpl/Extension/Extension.Manifest","MsPortalImpl/Widgets/Widgets.Common","MsPortalImpl/Services/Services.BrowserSettings","MsPortalImpl/UI/Compositions/UI.Composition"],(function(n,t,i,r,u,f,e){"use strict";function d(n){return e.bladeImplementedWithVirtualPart(n.bladeDefinition)&&MsPortalFx.find(MsPortalFx.mapMany(n.children,(function(n){return n.children})))}var s,o;Object.defineProperty(t,"__esModule",{value:!0});t.BladeTelemetry=t.bladeFullReadyTimeout=void 0;var l=MsPortalFx.Base.Diagnostics.Telemetry,c=l.ActionModifier,a=FxImpl.TelemetryContext;t.bladeFullReadyTimeout=6e4;var v=window,h=v.fx.getTimestamp,y=MsPortalFx.Base.Promises.cancelOnDispose,p=[undefined,"StartboardPart","SideBar","DeepLink"],w=(s={},s[0]="Small",s[1]="Medium",s[2]="Large",s[3]="XLarge",s[51]="Menu",s),b=(o={},o[0]="Default",o[1]="TemplateBlade",o[2]="FrameBlade",o[3]="MenuBlade",o[4]="AppBlade",o[5]="AzBlade",o[6]="ReactView",o),k=(function(){function o(n){this._diContainer=n;this._markers={};this._perfData={};this._additional={}}s=o;o.prototype.initializeBladeTelemetry=function(n,t,i,r){var a=this,u=this._perfData={includesExtensionLoadTime:!t.bladeDefinition},f=t.masterContainer,v=f&&f.locator,tt=v&&v.toFriendlyString(),it=f&&f.instanceId,y=f&&f.id,w=it||y,b=tt||y,o=t.openedByInfo,rt=o.openedByContext,c;this._blade=t;f&&f.getCompositionType()===e.CompositionType.Blade&&(c=f,c.bladeDefinition&&c.bladeDefinition.menuBlade&&(this._menuBlade=c,this._menuBladeTelemetry=c.diContainer.get(s)));o.openedBy&&(u.openedBy=p[o.openedBy],u.isFavorite=o.openedBy===2&&rt.isFavorite(),u.openedByPartName=o.openedByPartName);w&&(u.openedByBlade=w);b&&(u.openedByBladeName=b);r&&(u.preloadPartSettings=!0);i&&(i.autoOpenedByBlade&&(u.autoOpenedByBlade=i.autoOpenedByBlade),i.autoOpenedByPart&&(u.autoOpenedByPart=i.autoOpenedByPart));var k=t.extension,l=t.locator,ut=this._additional={extension:k&&k.name||l&&l.getExtensionName(),locator:l&&l.toFriendlyString(),assetType:n},d=function(n){a._markers[n]=h();a._markers["Menu"+n]=null},g=t.widget,nt=g&&g.timer;return nt&&(u.delayTime=nt()),performance.mark("BladeFullReady: "+ut.locator.toLowerCase()),d("BladeFullReady"),d("BladeSettled"),this.readyStartTime=h(),this.readyStartTimeCommon=Date.now(),this._perfData};o.prototype.traceBladeComplete=function(n,i,u){var e=this._blade,o,s;this._initializeTelemetryDetails(e,n);o=e.extension;this._perfData.extVersion=o&&this._diContainer.get(r.ManifestCache).getVersion(o.name);s=this._perfData;!s.rejectedPromises&&i<t.bladeFullReadyTimeout&&(clearTimeout(i),MsPortalFx.isFeatureEnabled("showhatsmodal")&&f.temporaryExtensionCount.incrementCount(e.extension.name),u&&(this._perfData.deepLinkContext=e.masterContainer.getDeepLinkContext()),this._bladeFullReadyTelemetry(c.Complete,e,s))};o.prototype.traceBladeLoadErrored=function(n,t){var i=!this._markers.BladeFullReady,r=i?"BladeErrored":"BladeLoadErrored";this._markers[r]=this._markers.BladeFullReady||h();i||this._traceWithState("BladeFullReady",c.Cancel,this._blade)();t=__assign(__assign({},this._perfData),t);this._traceWithState(r,n,this._blade,t)()};o.prototype.beginTraceBladeDisposed=function(){var n=this;this._blade&&(MsPortalFx.forEachKey(this._markers,(function(t,i){i&&n._traceWithState(t,c.Cancel,n._blade)()})),this._closedTime=this._markers.BladeClosed=h())};o.prototype.endTraceBladeDisposed=function(){this._blade&&this._traceWithState("BladeClosed",c.Complete,this._blade,{TotalTimeBladeOpen:this._closedTime-this.readyStartTime})()};o.prototype._initializeTelemetryDetails=function(n,t){var u=t.filter((function(n){return n.state==="rejected"})),i=this._perfData,r=n.bladeDefinition;i.lockedBlade=!!r.locked;i.useDetailContent=n.useDetailContent;i.bladeType=b[e.getBladeType(r)];i.bladeWidth=i.initialDisplayState===2?"Fullscreen":w[r.width]||"Fullscreen";i.reflowReady=!!r.reflowReady;i.inContextPane=!!(n.flags&1);i.isWeave=!!r.isWeave;i.resource=n.openedByInfo.openedByContext&&n.openedByInfo.openedByContext.deepLink;u.length===0?i.earlyOnInputsSetBlade=n.earlyOnInputsSet:i.rejectedPromises=u.length;i.telemetryName=n.telemetryName||""};o.prototype._traceTelemetry=function(n,t,i,r,u,f){var e=this._additional;a.usingState((function(){l.trace({extension:e.extension,source:"Shell",action:n,actionModifier:t,context:f,data:r,name:u.locator&&u.locator.toFriendlyString(),assetType:e.assetType,journeyId:u.journeyId,serviceTreeId:u.extension&&u.extension.serviceTreeId,duration:i})}),f)};o.prototype._traceWithState=function(n,t,i,r){var u=this,s=this._markers,b=s[n],f,e,y,p,w;if(!b)return MsPortalFx.noop;if(delete s[n],f=n==="BladeFullReady"&&(r===null||r===void 0?void 0:r.reactViewInitializeEnd)?r.reactViewInitializeEnd-this.readyStartTimeCommon:h()-this.readyStartTime,this._menuBlade&&i.useDetailContent){var o="Menu"+n,c=this._menuBladeTelemetry,v=c._markers||{};o in v&&(delete v[o],y=h()-c.readyStartTime,p=this._menuBlade.getCreationState(),e=function(n){u._menuBlade.await(4).finally((function(){a.usingState((function(){var s=u._menuBlade.locator,h=i.locator,e=u._menuBlade.menu,c=e&&e.getResourceType()||u._menuBlade.assetType,a=e&&e.getTelemetryInfo()||{};l.trace({name:s.toFriendlyString(),extension:s.getExtensionName(),source:"Shell",action:o,actionModifier:t,data:$.extend({detailName:h.toFriendlyString(),detailExtension:i.extension&&i.extension.name,detailDuration:f,type:c,resourceId:i.assetId()||i.parent&&i.parent.getCurrentResourceId()},r||{},n&&n(u._menuBlade)||{},a),duration:y,journeyId:i.journeyId})}),p)}))})}return w=i.getCreationState(),function(o,s,h){return u._traceTelemetry(n,t,h||f,MsPortalFx.extend2(r,o),i,w),e&&e(s),h||f}};o.prototype._bladeFullReadyTelemetry=function(n,t,i){var o=this,p=function(n){return n.locator.toFriendlyString().toLowerCase()},w=function(n){return"BladeFullReady: "+n},b=this._traceWithState("BladeFullReady",n,t,i),s=p(t),r=w(s),l=r+"-end",a,f;if(performance.mark(l),performance.measure(r,r,l),a=d(t),a)a.onBladeFullReady(r,l,e.getBladeType(t.bladeDefinition));f=t.widget.element[0];y(t,u.waitForBindings(f).timeout(1e4).then(MsPortalFx.noop,MsPortalFx.noop)).finally((function(){var n,l=h(),a=r+"-render",k=function(n){var t=n?p(n):s;performance.measure((n?"Menu":"")+"BladeFullRender: "+t,n?w(t):r,a)},i,u,e;performance.mark(a);k();i=l-o.readyStartTime;t.fullReadyTime=b({bladeRenderTime:i},(function(n){return k(n),{menuBladeRenderTime:l-o._menuBladeTelemetry.readyStartTime}}));v.requestAnimationFrame((function(){var n=document.createEvent("Event");n.initEvent("fxbladefullrender",!0,!0);f&&f.dispatchEvent(n)}));u=function(n){return __awaiter(o,void 0,void 0,(function(){return __generator(this,(function(u){switch(u.label){case 0:return[4,Q.delay(0)];case 1:return u.sent(),this._traceWithState("BladeSettled",c.Complete,this._blade,this._perfData)(__assign({bladeRenderTime:i,bladeReadyTime:t.fullReadyTime},n&&__assign({pendingExtensionOperationsCount:n.pendingOperationsCount,extensionWaitForSettledTime:n.waitDuration},n.interruptedByChild&&{interruptedByChild:!0}))),performance.measure("BladeSettled: "+s,r),[2]}}))}))};e=((n=t.extension)===null||n===void 0?void 0:n.waitForIdle)&&y(t,t.extension.waitForIdle(t.locator.name,t.instanceId));e?e.then(u):u()}))};var s;return s=__decorate([__metadata("fx:diagnostics",[n,"1"]),i.Value("composition"),__metadata("design:paramtypes",[i.Container])],o)})();t.BladeTelemetry=k}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Lens",["require","exports","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/Widgets/Widgets.Lens"],(function(n,t,i,r,u,f,e){"use strict";function a(n,t){var i=t.locate(n.locator);return i&&i.isSummary}function v(n,t,r){var h=n.get(i.DefinitionFinder),u=h.locate(t),s=new o(n,t,null,null,null,r),e;return u&&u.partInstances&&(e=[],u.partInstances.forEach((function(i){var u=f.create(n,t.withPartInstance(i.name),null,null,null,r);e.push(u)})),s.addChildren(e)),s}var o;Object.defineProperty(t,"__esModule",{value:!0});t.create=t.Instance=void 0;var s=MsPortalFx.Base,h=s.Diagnostics,c=r.CompositionType,l=h.createLog(n);o=(function(n){function t(t,r,u,f,e,o){var s=n.call(this,"Lens",t,r,u,f,e,o)||this;return s._childOnInputsSetsResolved=Q.defer(),s._finder=t.get(i.DefinitionFinder),s}return __extends(t,n),t.prototype.awaitChildrenOnInputsSetsResolved=function(){return this._childOnInputsSetsResolved.promise},t.prototype.getCompositionType=function(){return c.Lens},t.prototype._compose=function(n,t){var i=this,s=Q({}),f=a(this,this._finder),r=new e.ViewModel(this.id,this.diContainer),u,o;ko.computed(this,(function(){r.locked(n.options.locked())}));u=$(FxImpl.createElement("div",{"class":f?"fxs-portal-border":""}));this.widget=new e.Widget(u,r);f?(r.locked(!0),n.setSummary(u)):n.addChild(this.widget);this._finder.locateAsync(this.locator.getExtensionLocator()).then((function(n){var t=i._finder.locate(i.locator),u;t&&t.title&&(u=t.title,u?r.title(u):l.error("Lens {0} in extension {1} is missing title.".format(i.locator.toString(),n.name)))}));this.children&&(o=this.children.slice(),Q.allSettled(o.map((function(n){var t=n.await(3);return n.compose(i.widget),t}))).finally((function(){i._childOnInputsSetsResolved.resolve()})),this.save(),s.then((function(){t.resolve()})))},t})(u.Instance);t.Instance=o;t.create=v}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade",["require","exports","FxInternal/Utils/Promise","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Base/Telemetry","MsPortalImpl/Base/Base.DeepLink","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/Extension/Extension.Manifest","MsPortalImpl/Extension/ViewModelManager","MsPortalImpl/Interactions/Interactions.FocusHandler","MsPortalImpl/Interactions/Interactions.PortalReader","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/UI/UI.DeepLink","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Widgets/Widgets.Blade","MsPortalImpl/Widgets/Widgets.BladeContent","MsPortalImpl/Widgets/Widgets.PartError","MsPortalImpl/Widgets/Widgets.UIElementBase","MsPortalImpl/UI/Commands/UI.CommandBarManager","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/Commands/UI.ShellCommands","MsPortalImpl/UI/UI.JourneyManager","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.BladeTelemetry","MsPortalImpl/UI/Compositions/UI.Composition.CompositionAwaiter","MsPortalImpl/UI/Compositions/UI.Composition.CompositionBinder","MsPortalImpl/UI/Compositions/UI.Composition.Finder","MsPortalImpl/UI/Compositions/UI.Composition.Lens","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/Compositions/UI.Composition.Security","MsPortalImpl/Widgets/Widgets.Portal.init"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct,lt,at,vt,yt,pt){"use strict";function si(n){return n.getExtensionLocator()}function hi(n){var t=n&&si(n);return t&&t.name}function ii(n){return n&&n.toFriendlyString()}function cu(n,t,i){var f,l=n.createChildContainer("composition"),a=n.get(h.ViewModelManager).getBladeSequenceNumber(t.locator.getExtensionName(),t.locator.name),r=new yi(l,t.locator,null,null,null,a),e,c;if(r.registerForDispose((function(){return l.disposeAsync()})),e={},!i)throw new Error("masterContainer is required when creating a blade.");r.masterContainer=i;r.masterCommandId=t.masterCommandId;r.masterCommandName=t.masterCommandName;r.masterCommandExtension=t.masterCommandExtension;r.masterPartId=t.masterPartId;r.masterInvocationProperty=t.masterInvocationProperty;r.masterInputKeys=t.masterInputKeys;r.masterDetailsDefinition=t.masterDetailsDefinition;r.flags=t.flags;r.telemetryName=t.telemetryName;var v=t.masterPartId?t.masterPartId.split("-"):[],u=t.openedByContext,s=r.openedByInfo;return r.defaultMenuItemId=t.defaultMenuItemId,r.contentBladeReference=t.contentBladeReference,i.getCompositionType()===ut.CompositionType.Startboard&&(s.openedBy=v.length?1:u&&u.isFavorite?2:u&&u.deepLink?3:4,s.openedByContext=t.openedByContext,s.openedByPartName=t.masterPartId),c=n.get(o.DefinitionFinder),c.tryLocate(t.locator,e)&&(r.bladeDefinition=e.value,r.extension=c.locate(si(t.locator))),((f=t.locator)===null||f===void 0?void 0:f.name.toLowerCase().endsWith("_dx"))&&t.model&&(t.model.dxParameters=MsPortalFx.clone(t.model,!0),t.masterInputKeys.push("dxParameters")),r.setInputsViewModel(ht.CompositionBinder.createObservableModel(t.model)),r.bindings=t.bindings||[],r.restorationState=t.flags===undefined||t.flags&4?0:1,r}function lr(n){var t=n.openedByInfo,i=t&&t.openedByContext;return i&&i.openedAsHome}function ci(n){var t=n.masterContainer,i=t&&t.bladeDefinition;return!!(i&&i.menuBlade)}function ar(n){return!(n.menuBlade||n.style===12)}function vr(n,t,i){var f=n.options,u,r;f.showTranslucentSpinner(!1);i.menuBlade&&(n.clearDetailContent(),t.bladeWidth(2));u=t.contextMenu;r=u&&u.menuItems;r&&r.splice(0,r().length)}function yr(n){var t=n.effectiveInputs;return t&&t.length&&n.assetIdInputProperty&&n.assetType}function pr(n){var t=n&&n.options,i=t&&t.noticeTmplVm;return!!(i&&i.value)}function wr(n,t,i){var e,r={exists:!1,value:undefined},u,f;return yr(n)&&(e=MsPortalFx.find(n.effectiveInputs,(function(t){return t.property===n.assetIdInputProperty})),u=e&&e.valuesFrom,f=u&&u[0]&&u[0].property,f&&u[0].referenceType===1&&(r=vt.getModelValue(t,f),r.exists?r.value=ko.unwrap(r.value):wt.error("Asset id property '"+f+"' does not exist in model for composition '"+i+"'. Model='"+oi(t)+"'"))),r}function nr(n){return{id:ii(n.locator),instanceId:n.instanceId}}function br(n,t){for(var u,r=kt(n),f=function(n){var f=r[n],i,u;if(t(f))return i=f.containerWidget,i&&(u=document.activeElement,u&&$.contains(i.element[0],u)||setTimeout((function(){i.setFocus()}),150)),"break"},i=r.length-1;i>=0;i--)if(u=f(i),u==="break")break}function dt(n,t,i,r,u,e,o,s){var h=vt.getModelValue(i,r);h.exists?n.mapProperty(r,o||r).bind(t,i,!0,(function(){var n=ko.unwrap(vt.getModelValue(i,r,!0).value);u(n||e)})):s||f.isDesktopTraceEnabled&&wt.warning("The Blade VM with id "+t+" is missing the "+r+" field.")}function lu(n,t,i){var u=t?t.name:null,f=i?i.assetType:null,r=1;n.children.forEach((function(t){t.children.forEach((function(t){bi.trace({extension:u,source:ii(n.locator),action:"PartPosition",assetType:f,name:ii(t.locator),data:r});r++}))}))}function au(n,t,i){function r(n){u(n||null)}var u=ko.observable(),f=n.bladeDefinition;return ko.reactor(n,(function(){var e=ko.unwrap(t.icon),u,o,s;e?r(e):i?r(i):f.assetType?(u=void 0,(u=n.assetId())?(o=n.extension,s={assetId:u,assetType:f.assetType,extensionName:o.name},Q.delay(1).then((function(){return n.diContainer.get(a.AssetTypeService).mapAssetIdToDynamicSelectionAndIcon(s,"BladeIcon")})).then((function(n){r(n&&n.icon||b.defaultSvg)})).catch((function(){r(b.defaultSvg)}))):r(b.defaultSvg)):r()})),{icon:u}}function fi(n,t,i){eu&&wt.verbose("[BladeRebinding] "+t+" Blade: "+n+". Updated Properties: "+(oi(i,null,2)||"N/A"))}function vu(n,t,i){if(!n)return!1;var r=n.properties.filter((function(n){var t=n.compositionBindingDefinition;return t&&t.source&&t.source.modelType===1}));return r.length===0?!1:r.some((function(n){var r=ko.unwrap(t[n.sourceProperty]),u=ko.unwrap(i[n.sourceProperty]);return!MsPortalFx.deepEquals(r,u)}))}function yu(n,t,i,r){var o=!1,u,f,e=ko.observable(),s=function(t){var s=!1,h=t.onClick||t.onActivated,c,l;f&&(f.dispose(),f=undefined,u=undefined);c=MsPortalFx.find(kt(n),(function(t){return t.masterCommandName===gi.format(n.bladeDefinition.name)&&t.masterPartId===n.id}));c&&gt(n.diContainer).forceCloseBlade(c);t.selection?(s=!0,f=n.createChildLifetime(),u=nt.createOpenBladeCommand(f,n.diContainer,n,n.bladeDefinition,n.extension,gi.format(n.bladeDefinition.name)),e(u.viewModel.container),e().selectable.selectedValue(t.selection),l=!kt(n).length,r()&&l&&!o&&(u.execute(!1),o=!0)):h&&h.uri?(s=!0,f=n.createChildLifetime(),u=nt.createOpenLinkCommand(f,n.diContainer,n,n.bladeDefinition,n.extension,gi.format(n.bladeDefinition.name),h)):t.onClick&&(s=!0);i.contentState(t.state);i.contentStateDisplayText(t.text);i.statusBar.activatable(s)},h=function(n){n&&n.state!==0||(n={text:"",state:0,selection:null});s(n)};return t.subscribeAndRun(n,h),ko.reactor(n,(function(){var r=e()&&e().selectable.isSelected(),n=ai(t);i.statusBar.activated(r);r&&n&&typeof n.onActivated=="function"&&n.onActivated()})),function(){var i,n;if(u&&u.execute(!1),i=ai(t),i&&(n=i.onClick,n))if(typeof n=="function")n();else if(typeof n.onLinkOpened=="function")n.onLinkOpened(!1)}}function pu(){function r(){n&&(n.reject(new ei.CanceledError("Throttler cancel pending promise")),clearTimeout(i),n=null)}var n,t=0,i;return{rejectPendingPromise:r,throttle:function(){var f=Date.now(),e=f-t,o=e<or,u;return t=f,r(),o?(u=n=Q.defer(),i=setTimeout((function(){u===n&&(n.resolve(),n=null)}),or),u.promise):Q()}}}function tr(n){var t=ut.getBladeType(n);return t===3&&n.menuBlade.isV2||t===1&&n.templateBlade.isV2||t===2||t===5||t===6}function wu(n){n.subtitle("");n.titleSuffix("");n.subtitleSuffix("");n.description("");n.helpUri("");n.icon(ki.Blank());n.contentState(0);n.contentStateDisplayText("");n.disabled(!0)}function bu(n){while(n){if(ku(n))return!0;var t=n.masterContainer;n=t instanceof yi?t:null}return!1}function ku(n){var t=n.getInputPropertyBindings(),i=y.getGalleryItemIdFromBladeComposition(hi(n.locator),n.locator.name,t&&t.targetModel);return!!i}function gt(n){return n.get(rt.JourneyManager)}function du(n){if(MsPortalFx.isNullOrUndefined(n)||MsPortalFx.isNullOrUndefined(n.message))return n;var t=n.message;return typeof t=="string"?t:t.htmlTemplate}function gu(n){return ut.bladeImplementedWithVirtualPart(n.bladeDefinition)&&MsPortalFx.find(MsPortalFx.mapMany(n.children,(function(n){return n.children})))}function kt(n){return n.diContainer.get(ct.Finder).findBlades(n)}var bt,yi;Object.defineProperty(t,"__esModule",{value:!0});t.Instance=t.create=void 0;var ni=FxImpl.TelemetryContext,pi=ni.ContextType,wi=MsPortalFx.Base,ei=MsPortalFx.Errors,kr=wi.Constants,dr=kr.BladeParameterNames,ir=wi.Diagnostics,bi=ir.Telemetry,ki=wi.Images,gr=MsPortalFx.Extension,nu=gr.SetRequirement,tu=MsPortalFx.ViewModels,iu=tu.Controls.Notice,ru=iu.ViewModel,rr=bi.ActionModifier,uu=MsPortalFx.tryImmediateResolve,fu=window,ur=fu.fx.getTimestamp,wt=ir.createLog(n),ri=r.Asset,di=r.Blade,ui=r.Shell.Reader,gi="__{0}_StatusBarCommandDefinitionName__",eu=!!MsPortalFx.trace.bladerebind,fr=Math.random()<.5,ti=MsPortalFx.isNullOrUndefined,ou="fxs-menublade",er="fxs-blade-shows-pending",li=Array.isArray,or=1e3,su="ResourceMenuBlade",oi=ko.toJSON,sr=ko.utils,ai=sr.peekObservable,hu=MsPortalFx.forEachKey,hr=MsPortalFx.disposeDisposable,vi=JSON.stringify,cr=MsPortalFx.Base.Promises.cancelOnDispose;t.create=cu,(function(n){n[n.ErrorUnrecoverable=1]="ErrorUnrecoverable";n[n.ErrorInitializing=2]="ErrorInitializing";n[n.ErrorLoadingExtension=3]="ErrorLoadingExtension";n[n.ErrorLoadingDefinition=4]="ErrorLoadingDefinition";n[n.ErrorLoadingExtensionAndDefinition=5]="ErrorLoadingExtensionAndDefinition";n[n.ErrorLoadingFramePart=6]="ErrorLoadingFramePart";n[n.FullReadyTimeout=7]="FullReadyTimeout"})(bt||(bt={}));yi=(function(t){function f(n,i,r,f,e,s){var c=t.call(this,"Blade",n,i,r,f,e,s)||this;c._diContainer=n;c._disposablesEvents=[];c._partAwaiter=new st.CompositionAwaiter(!0);c._containerAwaiter=new st.CompositionAwaiter;c._bindingResult=ko.observable();c._disabled=!1;c._rebinding=!1;c._composing=!1;c._initialized=!1;c._callbacks=[$.Callbacks(),$.Callbacks(),$.Callbacks()];c._initialOnInputsSetDeferred=Q.defer();c._announce=new l.PortalReader(c,{idPrefix:"bladecompo"});c._bladeViewModelDeferred=Q.defer();c._compositionDeferred=Q.defer();c._commandsDeferred=Q.defer();c._lastInputsSetDeferred=Q.defer();c._lastInputsSetProperties={};c._perfData={};c._bladeSummaryCollapsed=!1;c._isOpenedByReferrer=ko.observable(!1);c._autoOpenSettingsDisabled=!1;c._bladeDefinitionDeferred=Q.defer();c._resumeMenuRenderingDeferred=Q.defer();c.bladeDefinitionPromise=c._bladeDefinitionDeferred.promise;c.masterContainer=null;c.containerType=1;c.masterInputKeys=[];c.masterDetailsDefinition=null;c.bindings=[];c.editScopeId=ko.observable();c.title=ko.observable("");c.subtitle=ko.observable("");c.titleSuffix=ko.observable();c.subtitleSuffix=ko.observable();c.description=ko.observable("");c.helpUri=ko.observable();c.shieldType=ko.observable();c.uiBlockers=ko.observableArray([]);c.icon=ko.observable(ki.Polychromatic.DefaultBlade());c.titleImageUri=ko.observable();c.rebindThrottler=pu();c.assetId=ko.observable();c.restorationState=0;c.openedByInfo={};c.menuDeepLink=ko.observable();c._beforePageUnload=function(n){return c.shouldAlertOnClose()&&(n.preventDefault(),n.returnValue=""),undefined};c._childrenCreated=!1;c._viewModelManager=n.get(h.ViewModelManager);c._finder=n.get(o.DefinitionFinder);c._telemetry=new ot.BladeTelemetry(n);n.set(ot.BladeTelemetry,c._telemetry);var a=c._sequenceNumber=s||h.getNextSequenceNumber(),v=0,y=c._updateRebindSequenceNumber=function(){c.instanceId="Blade_"+MsPortalFx.sessionId+"_"+a+"_"+v++};return y(),n.set(u.CompositionProvenance,new u.CompositionProvenance(i,c.instanceId)),c._shellViewModel={},c.title(w.getDefaultTitle(i&&i.name)),window.addEventListener("beforeunload",c._beforePageUnload),c._compositionDeferred.promise.then((function(){var n=c.bladeDefinition,t;n&&n.locked&&(t=c.getParts(),ko.reactor(c,(function(){var i=t.some((function(n){return n.triggeringLockedBladeSpinner()}));c.containerWidget.options.showTranslucentSpinner(i);c._composing||n.menuBlade||(i?c._announce.read(ui.bladeBusy):c._announce.read(ui.bladeReady))})))})),c}return __extends(f,t),f.prototype.shouldAlertOnClose=function(n){return this.children.some((function(t){return t.children.some((function(t){return t.shouldAlertOnClose(n)}))}))},f.prototype.getAlertOnCloseMessages=function(){var n=[];return this.children.forEach((function(t){t.children.forEach((function(t){var i=t.getAlertMessage();i&&n.push(i)}))})),n},f.prototype.isRestorable=function(){return this.restorationState===0?!kt(this).some((function(n){return n.restorationState===1})):!1},f.prototype.getViewModel=function(n,t){var i,r=this.locator,f,u;n=ti(n)?1:n;switch(n){case 1:i=this._shellViewModel;break;case 3:if(this.isComposed)this.bladeDefinition.viewModelName||wt.error("Blade '"+r+"' does not define an extension view model.");else throw new Error("Blade '"+this+"' needs to be composed before retrieving its extension view model.");i=Q.isPromise(this._extensionViewModel)?undefined:this._extensionViewModel;break;case 2:if(this.isComposed)this.actionBar?i=this.actionBar.getViewModel():(wt.error("Blade '"+r+"' does not have an action bar."),i={});else throw new Error("Blade '"+this+"' needs to be composed before retrieving its action bar's view model.");break;case 4:f=this._getCommands();u=ut.findCommand(f,t,this+"");i=u&&u.getViewModel();break;case 999:i={bladeParameters:this._shellViewModel};break;default:wt.error("Invalid model type '"+n+"' for blade '"+r+"'.")}return i||{}},f.prototype.selectedMenuItemId=function(){var n=this.menu,t=n&&n.getSelectedItem();return t&&t.id},f.prototype.setDeepLinkContext=function(n,t,i){this._perfData.deepLinkContext={deepLinkable:t,length:n.length,reason:i}},f.prototype.getDeepLinkContext=function(){return this._perfData.deepLinkContext},f.prototype.getDeepLink=function(n){var t=this;return Q(this.await(7).then((function(){return t.bladeDefinition.viewModelInputs&&t.await(4)})).then((function(){var i,r;return(t.useDetailContent||t.flags&1||(r=t.getInputPropertyBindings(),i=y.getDeepLink(t.diContainer,t.extension.name,t.bladeDefinition,r&&r.targetModel,{assetType:t.assetType,assetId:ko.unwrap(t.assetId),selectedMenuItemId:t.selectedMenuItemId(),setDeepLinkContext:function(n,i,r){return t.setDeepLinkContext(n,i,r)}})),ti(i)&&(t.useDetailContent||!n)&&t.masterContainer)?t.masterContainer.getDeepLink():i})))},f.prototype.getViewModelAsync=function(n,t){var i=this;return(n=ti(n)?1:n,n===1||n===999)?Promise.resolve(this.getViewModel(n)):this._compositionDeferred.promise.then((function(){if(i.isDisposed())throw new MsPortalFx.Errors.DisposedCanceledError;return n===4?i._commandsDeferred.promise.then((function(){var r=i._getCommands(),n=ut.findCommand(r,t,i+"");return n&&n.getViewModelAsync()})):n===3?i._extensionViewModel||Q.reject(new MsPortalFx.Errors.Error("No extension view model loaded")):i.getViewModel(n)}))},f.prototype.setInputsViewModel=function(n){this._shellViewModel=n;var t=this.bladeDefinition;t&&li(t.optionalInputs)&&t.optionalInputs.forEach((function(t){n[t]||(n[t]=ko.observable())}))},Object.defineProperty(f.prototype,"isInitialized",{get:function(){return this._initialized},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"eligibleForBinding",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"journeyPath",{get:function(){return this._journeyPath||(this._journeyPath=this._buildJourneyPath())},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"dirtyAndNotSaving",{get:function(){return this.diContainer.get(v.EditScopeManager).getStateObservable(this.editScopeId())()===1},enumerable:!1,configurable:!0}),f.prototype.getCompositionType=function(){return ut.CompositionType.Blade},f.prototype.isDefaultTitle=function(){return w.getDefaultTitle(this.locator.name)===this.title()},f.prototype.canAutoOpenSettings=function(){return!this._autoOpenSettingsDisabled&&!this._isOpenedByReferrer()},f.prototype.getPermissionPromise=function(){return this._hasPermissionsDeferred.promise},f.prototype.matchesLocatorAndModel=function(n,t){var r=this.bladeDefinition,i;return!n.equals(this.locator)||!r?!1:(i=ko.toJS(this._shellViewModel),n.equals(o.resourceMenu))?(t.id||"").toLowerCase()===(i.id||"").toLowerCase():(r.inputs||[]).every((function(n){return t[n]===i[n]}))},f.prototype.getInputsOnlyViewModel=function(){var n=this._shellViewModel,i=this.bladeDefinition,t=i&&i.outputs;return t&&t.length>0&&(n=MsPortalFx.clone(this._shellViewModel),t.forEach((function(t){delete n[t]}))),n},f.prototype.onAddingContent=function(n,t){return this.compose(n.getWidget(),t?{index:n.childElementCount.value}:null),Q()},f.prototype.onRemovingContent=function(n){n.getWidget().clear()},f.prototype.canRemoveContent=function(){return gt(this.diContainer).tryCloseBlade(this)},Object.defineProperty(f.prototype,"isDisabled",{get:function(){return this._disabled},enumerable:!1,configurable:!0}),f.prototype.isPinnable=function(){var n=this.bladeDefinition;return!!(n&&n.pinnable)},f.prototype.isEditable=function(){var n=this.bladeDefinition;return!!(n&&n.dxSourcePath)},f.prototype.getPinOptions=function(){var f=this,i,t,r,u,e=kt(this),n=e[0],o=!!(this.flags&1);return e.length===1&&n.useDetailContent&&n.isPinnable()?(i=o?Q(undefined):this.getDeepLink(),t=n.locator,r=n.getViewModel(),u=n.getOnPinFunction()):(t=this.locator,r=this.getViewModel(),i=Q(undefined),u=this.getOnPinFunction()),Q.all([u,i]).spread((function(n,i){var u={deepLink:i,bladeTitle:f.containerWidget.options.title.value,defaultMenuItemId:f.selectedMenuItemId()};return n?MsPortalFx.extend(u,{locator:t,onPin:n}):MsPortalFx.extend(u,{locator:t,model:r})}))},f.prototype.getOnPinFunction=function(){var n=this;return Q(this.await(3).then((function(){return n.getViewModelAsync(3).then((function(n){var t=n.content();return t&&t._msPortalFxV2ShellApi&&t._msPortalFxV2ShellApi().onPin}))})))},f.getSourceModified=function(n){return n.await(3).then((function(){return n.getViewModelAsync(3).then((function(n){var t=n.container;return t.onSourceModified}))}))},f.prototype.getAssetInstanceMetadataAsync=function(){var n=this;return Q(this.await(7)).then((function(){var i=n.bladeDefinition,t;return yr(i)&&!n.isDisabled&&!n.isDisposed()&&(t=wr(i,n._shellViewModel,n.locator.toString()),t.exists)?{id:t.value,type:n.assetType}:undefined}))},Object.defineProperty(f.prototype,"assetType",{get:function(){var n=this.bladeDefinition;return n&&n.assetType},enumerable:!1,configurable:!0}),f.prototype.offRebind=function(n,t,i){var r=this;[n,t,i].forEach((function(n,t){n&&r._callbacks[t].remove(n)}))},f.prototype.onRebind=function(n,t,i){var r=this;[n,t,i].forEach((function(n,t){n&&r._callbacks[t].add(n)}))},f.prototype.save=function(n){this._composing||this._rebinding||pr(this.widget)||!this.masterContainer||t.prototype.save.call(this,n)},f.prototype.rebindAsync=function(n){var t=this,r;this._updateRebindSequenceNumber();ni.provideContext((function(){t._creationState=ni.getState()}),pi.Blade,nr(this));r=this.widget;c.FocusHandler.Instance.registerContainerForFocus(r,this.containerWidget);this.containerWidget.resetInternalState();var f=pt.getPortalViewModel(this.diContainer),i,e=ut.deepSubset(this._shellViewModel,n),u=function(){fi(t,"Rebind COMPLETED.");t._rebinding=!1;t.save();f.customEvents.trigger("fxbladerebound",{id:t.id});t.widget.options.loaded(!0);t.diContainer.get(nt.CommandState).commandsEnabled(!0);c.FocusHandler.Instance.notifyContainerReadyForFocus(r)};return fi(this,"Rebind STARTED.",n),this._rebindValidationPromise=null,this._waitToRebindPromise=null,this._directoryInfoPromise=null,e?(fi(this,"Updated properties are empty or are equal to the current blade properties. Aborting rebind.",n),this.rebindThrottler.rejectPendingPromise(),u(rr.Cancel),i=Q({})):(this._rebinding=!0,this._hasPermissionsDeferred=Q.defer(),this._autoOpenSettingsDisabled=this.useDetailContent,this.bladeDefinition&&!this.bladeDefinition.locked&&this.widget.options.loaded(!1),this.diContainer.get(nt.CommandState).commandsEnabled(!1),i=this._waitToRebindPromise=this.rebindThrottler.throttle().then((function(){return t.isDisposed()?Q.reject(new ei.CanceledError("Rebind Canceled. Blade is already disposed."+t)):i===t._waitToRebindPromise?(fi(t,"Rebind after throttle.",n),t._rebindAsync(n).finally((function(){i===t._waitToRebindPromise&&u(rr.Complete)}))):Q.reject(new ei.CanceledError("Another rebind already started"))}))),i},f.prototype.getTelemetryContextState=function(){return this._creationState},f.prototype._rebindAsync=function(n){var t=this,i=this._rebindValidationPromise=this.await(7).then((function(){if(!t._validateRebindProperties(n))return Q.reject(new MsPortalFx.Errors.CanceledError)})),r=function(i){hu(n,(function(n){vt.setModelValue(t._shellViewModel,n,i?i[n]:undefined)}));i&&(t._journeyPath=t._buildJourneyPath())};return this.useDetailContent||this.containerWidget.clearDetailContent({callback:function(){var n=t.menu;n&&n.setDefaultId({rebinding:!0})},setPlaceholderDetailContent:!!this.bladeDefinition.menuBlade&&!kt(this).length}),Q(i.then((function(){var o=t._bindingsToExtensionViewModel&&t._bindingsToExtensionViewModel.properties.map((function(n){return n.compositionBindingDefinition})).filter((function(n){return!!n})),e,f,u;return t._lastInputsSetDeferred.reject(new MsPortalFx.Errors.CanceledError("New rebind started")),t._lastInputsSetDeferred=Q.defer(),e=(o||[]).filter((function(n){return!n.optional})),t._lastInputsSetProperties=vt.mapSourceModelToTargetModel(n,e,1,t+""),vu(t._bindingsToExtensionViewModel,t._shellViewModel,n)||t._lastInputsSetDeferred.resolve(),t.isDisposed()?Q.reject(new MsPortalFx.Errors.DisposedCanceledError):i&&i!==t._rebindValidationPromise?Q.reject(new MsPortalFx.Errors.CanceledError("Another rebind has started")):(fi(t,"Updating blade properties.",n),f=t._callbacks,f[0].fire(n),u=t._bindingResult()&&t._bindingResult().inputsWatcherConfig,u&&ht.CompositionBinder.turnOnInputsSetSuppressionOn(u),r(undefined),t._clearEditScopeId(),t.setInputsViewModel(t._shellViewModel),(t.bladeDefinition.optionalInputs||[]).forEach((function(n){t._shellViewModel[n](undefined)})),r(n),t._setEditScope(),u&&ht.CompositionBinder.turnOnInputsSetSuppressionOff(u),f[2].fire(n),t.bladeDefinition.viewModelInputs||t._hasPermissionsDeferred.resolve(),t._lastInputsSetDeferred.promise.catch((function(){})).finally((function(){fi(t,"Inputs set promise completed.",n);t.save();f[1].fire(n)})))})))},f.prototype.onDetailContainersChanged=function(){var n=this,t,i;this._finder.locateAsync(this.locator).then((function(t){n._widgetsCreated&&n._initWidgetFromDefinition(t)}));t=kt(this);MsPortalFx.isFeatureEnabled("earlymenucontentvm")&&this.menu&&t.length>0&&(i=t[0],cr(this,i.await(7).then((function(){var n=gu(i);return n&&n.await(5)}))).finally((function(){return n._resumeMenuRenderingDeferred.resolve()})))},f.prototype._compose=function(n,t,i){var r=this,e,o,c,l,f;if(!this.isComposed&&!this._composing){if(this._composing=!0,this._perfData=this._telemetry.initializeBladeTelemetry(i&&i.assetType,this,i,fr),this._compositionDeferred.promise.then((function(){return t.resolve(),r._perfData.bladeLoadedTime=r.compositionTime=ur()-r._telemetry.readyStartTime,pr(r.widget)?void 0:r._setupCommandBarAndContextMenu()}),(function(){t.reject()})).then((function(){r._commandsDeferred.resolve()})),this.unrecoverableErrorMessage){this._composeErrorBlade(n,i,bt.ErrorUnrecoverable,this.unrecoverableErrorMessage);return}var u=this.locator,h=this._finder,s=this._viewModelManager.tryEarlyGetViewModel(si(u).name,u.name,FxImpl.mapValues(this._shellViewModel,ko.unwrap),{menuId:this.defaultMenuItemId,inContextPane:!!(this.flags&1),isMenuBladeContent:!!at.tryGetParentMenuBlade(this,gt(this.diContainer).activeJourney()),fetchDefinition:!this.bladeDefinition,sequenceNumber:this._sequenceNumber});s.then((function(n){n.viewModel&&(r._perfData.rpcDurationMs=n.rpcDurationMs,r._perfData.viewModelLoadIndex=n.viewModelLoadIndex)}));this.tryGetVirtualPartViewModel=function(){return MsPortalFx.tryImmediateResolve(s,(function(n){var t=n.viewModel;return t&&(r.tryGetVirtualPartViewModel=function(){return Q.resolve(null)}),t}))};e=this.bladeDefinition?Q(this.bladeDefinition):s.then((function(){return h.locateAsync(u)}));e.then(this._bladeDefinitionDeferred.resolve);o=e.valueOf();o&&o.viewModelBundleLoading&&(o.viewModelBundleLoading=null);c=this.extension?Promise.resolve(this.extension):h.locateAsync(si(u));this._shouldShowPendingBlade()?(l=function(){var t=r._createNewBladeWidget(n,i);t.element.addClass(er);t.options.close=function(){return gt(r.diContainer).tryCloseBlade(r,1)};r._widgetsCreated=!0;r.containerWidget=t;r.widget=t.getContentWidget();u.name===su&&r.containerWidget.setupAsKnownMenuBlade()},l()):(f=this.masterContainer,f&&f.bladeDefinition&&f.bladeDefinition.menuBlade&&(!f.containerWidget.isMenuBladeLoadingDetailBlade()||f.containerWidget.element.hasClass(er))||this._loadingSignalToTopBar(n.element));e.then((function(t){var f,e;return r.bladeDefinition=t,t.menuBlade||r._announce.read(ui.bladeLoading),r.openedByInfo.openedBy===3&&!r.isPinnable()&&r.masterInputKeys&&r.masterInputKeys.length&&(f=r.openedByInfo.openedByContext.deepLink,f&&f.match("^#([^/]+/)?blade/")&&r._trace({extension:r.extension&&r.extension.name||hi(u),action:"BladeDeepLinkedNotPinnable",source:"Shell",data:{resource:f}})),r.isDisposed()||(r._initWidgets(t,n,i),r._showLoadingIndicator()),e=bt.ErrorLoadingExtensionAndDefinition,c.then((function(u){e=bt.ErrorLoadingDefinition;r.extension=u;!r.isDisposed()&&(t.attributes&4||r._validateParameters(n,t,i))&&r._validateDefinition(n,t,i)&&(r.bindings=r.bindings.concat(ht.CompositionBinder.mapInputBindingDefinitions(t.bindings,r,(function(n){n.source.scope===vt.ReferenceScope.CurrentContainer&&(n.autoRebindWhenSourceDisposes=!0)}))),r._createChildrenFromDefinition(t),r.save(),r._initialized=!0,r._composeBlade(u,t))})).catch((function(t){r._composeErrorBlade(n,i,e,t)}))})).catch((function(t){var u=bt.ErrorLoadingExtensionAndDefinition;e.isRejected()||(u=bt.ErrorLoadingExtension);r._composeErrorBlade(n,i,u,t)})).finally((function(){r._loadedSignalToTopBar()}))}},f.prototype._selectedMenuItemIcon=function(){var n=null,t;return ci(this)&&(n=this.masterContainer.menu),t=n&&n.getSelectedItem(),t&&ko.unwrap(t.icon)},f.prototype._shouldShowPendingBlade=function(){var n=(this.flags&16)!=0,t=(this.flags&1)!=0;return!ci(this)&&(!n||t)&&!bu(this)},f.prototype._loadedSignalToTopBar=function(){this._loadingHintDisposer&&(this._loadingHintDisposer(),this._loadingHintDisposer=null)},f.prototype._loadingSignalToTopBar=function(n){var t=this;this._loadedSignalToTopBar();this._loadingHintDisposer=function(){n.trigger("fxloadingontopbar",{id:t.id,cancel:!0})};n.trigger("fxloadingontopbar",{id:this.id,cancel:!1})},f.prototype._showLoadingIndicator=function(){var n=this;this.widget.options.loaded(!1);this._hasPermissionsDeferred=Q.defer();Q.allSettled([this._hasPermissionsDeferred.promise,this._compositionDeferred.promise]).finally((function(){n.widget.options.loaded(!0)}))},f.prototype._rejectPermissionsPromise=function(){this._hasPermissionsDeferred?this._hasPermissionsDeferred.reject():this.widget&&this.widget.options.loaded(!0)},f.prototype._validateRebindProperties=function(n){var t="",i=this.bladeDefinition.templateKeyInputs||[];return i.some((function(t){return!n.hasOwnProperty(t)}))?t="Properties to rebind must include all blade inputs marked as keys.":i.some((function(t){return li(n[t])}))&&(t="Properties to rebind cannot be of Array type."),t&&wt.error("[Blade Rebind] "+t+" Rebind properties:'"+vi(n)+"', Blade keys:'"+vi(i)+"'."),!t},f.prototype._summaryCollapsed=function(){var i=this,t=!1,n,r;return(this.bladeDefinition.lenses||[]).some((function(u){var e=i.locator.withLens(u.name),f=i._finder.locate(e);return f&&f.isSummary&&f.partInstances&&(t=!0,n=f.partInstances[0],r=e.withPartInstance(n.name)),t})),t?Q(this._sharedSettings.querySetting(2,"[PartIdentityState]-"+r.toString()).then((function(n){return n?FxImpl.fromSerializableObject(n):null}),(function(){return null})).then((function(t){return t&&t.content&&t.content.collapsed!==undefined?!!t.content.collapsed:n.inline&&n.inline.options?!!n.inline.options.collapsed:null}))):Q(!0)},f.prototype._checkIfOpenedByReferrer=function(n,t){var i=dr.ReferrerInfo,r=n.indexOf(i)>-1,u=ko.unwrap(t[i])!==undefined;return r&&u},f.prototype._composeBlade=function(n,t){var i=this,r;fr&&this._summaryCollapsed();t.assetType&&this.containerWidget.options.associatedWithAsset(!0);r=this._journey=gt(this.diContainer).activeJourney();this.journeyId=r&&r.id||"N/A";this._setupViewModel();t.editScopeType&&r&&r.observeEditScopeChanges(this,{editScopeId:this.editScopeId,ownerType:this.locator.type,ownerLocatable:this,disposeOnSelectionChange:!1});this._isOpenedByReferrer(this._checkIfOpenedByReferrer(t.optionalInputs||[],this._shellViewModel));this._setupInputBindings();this._setupExtensionViewModel();this._setupPreviewListener(n,t);this._trackAssetIdChange();this._waitForNoticeIfAny(t.waitForInputsSet).then((function(n){n&&i._composeAndRestoreLayout().then((function(){kt(i).forEach((function(n){n.notifyContainer(i)}));i.masterContainer&&i.masterContainer.notifyContainer(i);lu(i,i.extension,t);i.save();i.actionBar?i.actionBar.await(7).then((function(){i._compositionDeferred.resolve()})):i._compositionDeferred.resolve()}),(function(){i._compositionDeferred.reject()}))}));this.onRebind();this.containerWidget.bladeDefinitionLoaded=!0;this.containerWidget.trigger("fxbladerepos")},f.prototype._waitForNoticeIfAny=function(n){var t=this;return n?Q(this.await(3)).then((function(){if(t.isDisposed())return!0;var n=Q(t._extensionViewModel);return MsPortalFx.tryImmediateResolve(n,(function(n){var i=ai(n.container._msPortalFxNotice),r=ti(i);return r||t._renderNotice(i),r}))})):Q(!0)},f.prototype._buildJourneyPath=function(){var i=this,n=this.masterContainer,r=n&&n.journeyPath||[],t={model:{}};return(this.masterInputKeys||[]).forEach((function(n){t.model[n]=ko.unwrap(i._shellViewModel[n])})),r.concat([et.getBladeOpenerJourneyPathSegment(this),MsPortalFx.toSortedString(t),this.locator.toString(),])},f.prototype._createNewBladeWidget=function(n,t){var f=this,i,u;return t=t||{},i=new w.ViewModel(this.id,this._diContainer,this.widgetState(),{name:this.locator.name,extensionName:hi(this.locator)}),i.asSubJourney=(this.flags&8)!=0,i.customHome=lr(this),i.isHelpBlade=!!(this.flags&32),MsPortalFx.isFeatureEnabled("mspinfo")&&this.assetId.subscribeAndRun(this,(function(n){i.directoryInfo(null);n&&(f._directoryInfoPromise=MsPortalFx.require("MsPortalImpl/Services/Services.ProjectedDirectories").then((function(n){return f._diContainer.getAsync(n.ServicesProjectedDirectories)})).then((function(t){return t.hasProjectedDirectories().then((function(u){if(u)return t.getDirectoryByResourceId(n).then((function(n){var u=ki.StatusBadge,t=n&&(n.displayName||n.id),f=u.Info();t||(t=r.ResourceFilter.Directory.unknownText,f=u.Unknown());i.directoryInfo({directoryName:r.Directory.label.format(t),directoryIcon:f})}))}))})))})),u=w.createBladeWidget($(FxImpl.createElement("section")),i),t.index>=0?n.insertChild(u,t.index):n.addChild(u),u},f.prototype._initWidgets=function(n,t,i){var d,y,st;i=i||{};var r,u,s=null,h=null,l=this.masterContainer,p=l&&l.containerWidget,o=this.useDetailContent||ci(this),nt=n.style===12,a=!!n.menuBlade,ht=(this.flags&1)!=0,ct=(this.flags&16)!=0,w=ct&&!ht,f=this.useDetailContent=o&&ar(n)||w,tt=o&&!f,it=lr(this);if(this._autoOpenSettingsDisabled=f,w||f){h=new b.ViewModel(this.id,{displayState:p.options.displayState,diContainer:this.diContainer},{name:this.locator.name,extensionName:hi(this.locator)});h.applyViewSettings(this.widgetState());r=p;r.options.isMenuBlade(!0);var lt=l.selectedMenuItemId(),rt=o&&this.masterContainer.menu,k=rt&&rt.getDefaultItem().id||"overview";r.options.isDefaultItemSelected(lt===k);r.options.pinEnabled(!1);r.options.pinVisible(!1);r.options.editEnabled(!1);r.options.editVisible(!1);this.getDeepLink().then((function(n){l.menuDeepLink(n);r.options.deepLink(e.getMenuIdFromDeepLink(n)!==k?e.replaceMenuIdFromDeepLink(n,k):n)}))}else a||this.getDeepLink().then((function(n){r.options.deepLink(n)}));if(w?u=r.openBladeInPlace(this,h):f?u=r.setDetailContent(h):this._widgetsCreated?(r=this.containerWidget,s=r.options,u=this.widget):(r=this._createNewBladeWidget(t,i),s=r.options,u=r.getContentWidget()),this._widgetsCreated=!0,this.containerWidget=r,this.widget=u,o||(r.options.customHome=it),d=gt(this.diContainer).activeJourney(),d){var ft=d.children,g=ft[ft.length-2],v=g&&g.masterContainer,et=v&&v.containerWidget,at=et&&et.options,ot=v&&v.bladeDefinition,vt=ot&&ot.menuBlade,yt=vt&&ar(g.bladeDefinition)&&!at.useActivationStyle;(tt||yt)&&s&&(s.asSubJourney=!0)}u.options.isV2Blade(tr(n));f?u.element.data(ut.CompositionInstanceDataName,this):r.element.data(ut.CompositionInstanceDataName,this);this._attachEventHandlers(r,u,f,tt,o,p);this.widgetState(u.saveViewSettings());nt&&u.options.bladeStyle(12);y=nt||f||a||it||n.width===3||n.reflowReady;this.flags&1||y||n.initialDisplayState===2||(y=!0,u.options.forcedMaximize(!0));st=this._perfData.initialDisplayState=y?2:n.initialDisplayState||1;r.options.displayState(st);this._initContainerWidgetFromDefinition(n,r.options);this._initWidgetFromDefinition(n);f&&n.initialDisplayState===1&&u.setContentWidth();o?r.options.showBladeIcon(!!r.options.associatedWithAsset()):r.options.showBladeIcon(!!n.assetType);u.initializeLayout();r.initializeLayout({setPlaceholderDetailContent:a&&!kt(this).length,callback:function(n){a&&n.addClass(ou)}});c.FocusHandler.Instance.registerContainerForFocus(u,r);u.options.locked(n.locked||!1)},f.prototype._initContainerWidgetFromDefinition=function(){var i=this.useDetailContent,n=this.masterContainer,t=n&&n.bladeDefinition;t&&t.menuBlade&&!i&&n.containerWidget.options.displayState(1)},f.prototype._initWidgetFromDefinition=function(n){var u=ti(n.width)?1:n.width,f=ti(n.reflowReady)?!1:n.reflowReady,t,r,i;if(this.containerWidget.options.useActivationStyle=!!n.activationStyle,t=this.widget.options,t.bladeWidth(u),t.bladeStyle(n.style),t.reflowReady(f),this.flags&1){t.displayState(1);r=n.menuBlade?n.contextPaneWidth||3:n.contextPaneWidth;this.containerWidget.setContextPaneWidth(r);i=void 0;switch(n.style){case 12:i=12;break;case 6:case 8:case 4:case 3:case 9:case 10:i=4;break;default:i=7}t.bladeStyle(i)}},f.prototype._composeErrorBlade=function(n,t,i,u){var e,o,f,s;if(!this.isDisposed()){e=this.locator;this.bladeDefinition=this.bladeDefinition||{name:e&&e.name,lenses:[],locked:!0};var h=u&&u.message||MsPortalFx.getLogFriendlyMessage(u)||"N/A",l=u.data,a=u.stack,c=__assign(__assign({details:h,resourceId:this._findResourceId()},l),{stack:a});this._telemetry.traceBladeLoadErrored(bt[i],c);o="Blade '"+this+"' has been turned to error mode. Details: "+h;wt.error(o,undefined,c);this._widgetsCreated||this._initWidgets(this.bladeDefinition,n,t);f=this.containerWidget;s=f.options;s.locked(!0);s.titleImageUri(undefined);this._renderError({message:r.PartError.titleContent,summaryItems:[{label:r.PartError.errorReason,value:bt[i]}],details:u},{bladeTitle:di.error});this._compositionDeferred.reject(new MsPortalFx.Errors.CanceledError(o));this._rejectPermissionsPromise();this._announce.read(ui.bladeError);f.bladeDefinitionLoaded=!0;f.trigger("fxbladerepos")}},f.prototype.disableForAssetDeleted=function(n,t){var r,i,u,f;if(this.useDetailContent){this.masterContainer.disableForAssetDeleted(n,t);return}if(r="Blade "+this+" "+(n?"closed":"disabled")+" because asset deleted. Reason: "+t,n)wt.warning(r),gt(this.diContainer).forceCloseBlade(this);else{for(i=this.children.length-1;i>=0;i--)this.removeChild(this.children[i]);u=this.containerWidget;f=u&&u.options;f&&f.titleImageUri(undefined);this._renderError({message:ri.deletedSubTitle,code:410},{bladeTitle:ri.deletedTitle});this.bindings=[];this._compositionDeferred.reject();this._rejectPermissionsPromise();wt.warning(r)}this.save()},f.prototype.resetLayout=function(n){var t=this;return Q(this.await(7).then((function(){var r=kt(t)[0],i,u,f;return r&&r.useDetailContent?r.resetLayout(n):(i=t.diContainer,n?u=Q(6):(f=new p.MessageBox(di.resetConfirmationTitle,di.resetConfirmationText,4),u=i.getAsync(p.DialogManager).then((function(n){return n.showDialog(f,t.widget,t.widget.element[0],{locator:t.locator})}))),u.then((function(n){var r,u;if(n===6){if(r=gt(i).discardEditsOfBlade(t,{includeSelf:!0,includeDescendants:!0,force:!0}),!r.successful){wt.error("Unexpectedly failed to discard changes on the blade with id: '"+t.id+"'");return}if(u=gt(i).closeChildBlades(t),!u.successful){wt.error("Unexpectedly failed to close child blades of the blade with id: '"+t.id+"'");return}t.widget.options.loaded(!1);t.children.forEach((function(n){n.children.forEach((function(n){n.clearIdentitySettings()}))}));t.removeChildren();t._childrenCreated=!1;t._createChildrenFromDefinition(t.bladeDefinition);t._removeRedirectParts();t._composeChildren();t.save();t.widget.options.loaded(!0)}})))})))},f.prototype._setupCommandBarAndContextMenu=function(){var i=this,n=this.widget.options,r=this.bladeDefinition,t;return hr(this._commandBarLifetime),t=this._commandBarLifetime=this.createChildLifetime(),Q(g.create(t,this,this.diContainer,this._shellViewModel).then((function(){i._composeShellCommands(n.contextMenu.menuItems,r.locked,n.displayState);t.registerForDispose((function(){n.commandBar.menuItems([]);n.commandBar.items([]);n.contextMenu.menuItems([])}))})))},f.prototype._setupInputBindings=function(){var n=this;ht.CompositionBinder.setupPropertyBindings(this.diContainer,this,this.getInputPropertyBindings(),this.bindings);this.getInputPropertyBindings().addPropertyChangedHandler((function(){n.save()}))},f.prototype.getMenuWidget=function(){return this.menu},f.prototype.getComposedParts=function(){return this._partAwaiter.resolvedCompositions},f.prototype.getParts=function(){return MsPortalFx.mapMany(this.children,(function(n){return n.children}))},f.prototype.getInputPropertyBindings=function(){return this._inputPropertyBindings||(this._inputPropertyBindings=new vt.PropertyBindings(this+"",this._shellViewModel)),this._inputPropertyBindings},f.prototype.awaitComposedPart=function(n,t){return this._partAwaiter.await(n,t)},f.prototype.notifyPartComposed=function(n){this._partAwaiter.resolve(n)},f.prototype.getWaitingCompositions=function(){return this._partAwaiter.waitingCompositions},f.prototype.await=function(n){switch(n){case 3:return i.toPromise(this._lastInputsSetDeferred.promise);case 4:return i.toPromise(this._initialOnInputsSetDeferred.promise)}return t.prototype.await.call(this,n)},f.prototype.resolveInitialOnInputsSet=function(){this._initialOnInputsSetDeferred.resolve()},f.prototype.dispose=function(n){var i=this;window.removeEventListener("beforeunload",this._beforePageUnload);this._telemetry.beginTraceBladeDisposed();this._releaseResources(n);this.masterContainer&&!this.masterContainer.isDisposed()&&this.masterPartId&&MsPortalFx.tryImmediateResolve(this.masterContainer.awaitComposedPart(null,ut.getIdMatchFunc(this.masterPartId)),(function(n){n.notifyDetailBladeClosed(i)}));t.prototype.dispose.call(this,n);this._telemetry.endTraceBladeDisposed();ci(this)||this._announce.read(ui.bladeClosed);this._loadedSignalToTopBar()},f.prototype._releaseResources=function(n){var t=this;hr(this._disposablesEvents);this._disposablesEvents=[];[this._inputPropertyBindings,this._bindingsToBladeWidgetModel,this._bindingsToExtensionViewModel].forEach((function(n){n&&(n.unbind(),n=null)}));n||this._disposeEditScopes();this._extensionViewModel&&this.extension&&MsPortalFx.tryImmediateResolve(Q(this._extensionViewModel),(function(n){t._viewModelManager.releaseViewModel(n);t._extensionViewModel=Q.reject(new MsPortalFx.Errors.DisposedCanceledError)}));this._callbacks.forEach((function(n){n.empty()}));this._journey=null},f.prototype.awaitContainer=function(n,t){return this._containerAwaiter.await(n,t)},f.prototype.onInvocationStarted=function(){this._autoOpenSettingsDisabled=!0},f.prototype.notifyContainer=function(n){this._containerAwaiter.resolve(n)},f.prototype.getDiagnosticsData=function(){return $.extend(t.prototype.getDiagnosticsData.call(this),{title:oi(this.title),detailBlades:kt(this).map((function(n){return n.id})),bindings:ht.CompositionBinder.mapBindingsToFriendlyObjects(this.bindings)})},f.prototype.getAssetId=function(){var i=this;if(!this.bladeDefinition||!this.bladeDefinition.assetIdInputProperty)return Q.reject();var r=function(n){var t=i._tryGetAssetIdFromBinding();t&&t.exists?n.resolve(ko.unwrap(t.value)):n.reject()},n=this._bindingResult,u=function(t){n().allInputsSet()?r(t):n().allInputsSet.subscribe(i,(function(n){n&&!t.promise.isFulfilled()&&r(t)}))},t=Q.defer();return n()?u(t):n.subscribe(this,(function(n){n&&!t.promise.isFulfilled()&&u(t)})),t.promise},f.prototype.setViewModelForTemplateOrMenuBlade=function(n){var i=this,r=n===null||n===void 0?void 0:n.internal,u,t;r&&(this._bladeDefinitionDeferred.promise.then((function(n){var t=n.viewModelBundleLoading,u,f,e;t&&(n.viewModelBundleLoading=null,u=r.getViewModelStart,f=t.end,u&&f&&(i._perfData.getViewModelDelay=u-f),e=t.duration,i._perfData.bundleLoadingTime=e)})),u=r,t=function(n){var t;(t=u[n])===null||t===void 0?void 0:t.subscribeAndRun(i,(function(t){MsPortalFx.isNullOrUndefined(t)||(i._perfData[n]=t)}))},t("prepareFirstAjaxTime"),t("ajaxTime"),t("onInitializeAsyncTime"),t("reactViewInitializeEnd"),t("preAjaxRpc"),r.interruptedParent&&(this._perfData.interruptedParent=!0));this._bladeViewModelDeferred.resolve(n)},f.prototype.setInputsSetPromise=function(n){var t=this;n.finally((function(){t._initialOnInputsSetDeferred.resolve();t._lastInputsSetDeferred.resolve()}))},f.prototype.logFrameBladeLoadError=function(n){this._trace({action:"IFrameBladeTimeout",data:{details:n}})},f.prototype._trace=function(n){var t=this.locator,i=t&&si(t),r=i&&i.name;bi.trace({extension:n.extension||r,source:n.source||"Shell",action:n.action,actionModifier:n.actionModifier,name:n.name||ii(t),data:n.data,journeyId:this.journeyId,duration:n.duration})},f.prototype._trackAssetIdChange=function(){var n=this,t;this.bladeDefinition.menuBlade?(t=MsPortalFx.find(MsPortalFx.mapMany(this.children,(function(n){return n.children}))),ko.reactor(this,(function(){n.assetId(t.assetId())}))):ut.bladeImplementedWithVirtualPart(this.bladeDefinition)?ko.reactor(this,(function(){var t=wr(n.bladeDefinition,n._shellViewModel,n.locator.toString());t.exists&&n.assetId(t.value)})):ko.reactor(this,(function(){var i=n._bindingResult(),t;i&&i.allInputsSet()&&(t=n._tryGetAssetIdFromBinding(),t&&t.exists&&n.assetId(ko.unwrap(t.value)))}))},f.prototype._tryGetAssetIdFromBinding=function(){var t=this,n=MsPortalFx.find(this._bindingResult().propertyBindings.properties,(function(n){return n.targetProperty===t.bladeDefinition.assetIdInputProperty}));return n?vt.getModelValue(n.sourceModel,n.sourceProperty):null},f.prototype._setupViewModel=function(){var n=this;(this.bladeDefinition.outputs||[]).forEach((function(t){n._shellViewModel.hasOwnProperty(t)||(n._shellViewModel[t]=ko.observable(undefined))}));this._setEditScope()},f.prototype._setEditScope=function(){if(this.bladeDefinition.editScopeType){var n=this._journey&&this._journey.ambientSettings.getItem(this.journeyPath);if(n&&n.value&&n.value.editScope)this.editScopeId(n.value.editScope.editScopeId);else{this.editScopeId(MsPortalFx.getUniqueId());this.diContainer.get(v.EditScopeManager).onEditScopeCreated(this.editScopeId())}this._shellViewModel[ut.EditScopeIdPropertyName]||(this._shellViewModel[ut.EditScopeIdPropertyName]=ko.observable());this._shellViewModel[ut.EditScopeIdPropertyName](this.editScopeId())}},f.prototype._updateForHasPermissions=function(n){var t=this;return Q(this.getViewModelAsync(3).then((function(i){var r,u;t.isDisposed()?wt.warning("Blade '"+t.locator.toString()+"' disposed when checking permissions."):(r=i.container,n?(MsPortalFx.isNullOrUndefined(ai(r.unauthorizedMessage))||r.unauthorizedMessage(null),t._hasPermissionsDeferred.resolve()):(u=r.unauthorized(),u&&u.finally?u.finally((function(){t._hasPermissionsDeferred.reject()})):t._hasPermissionsDeferred.reject()))})))},f.prototype._setupExtensionViewModel=function(){var n=this,s=this.widget,f,i,u=this.bladeDefinition,o=ut.bladeImplementedWithVirtualPart(u),h=function(t){return f=n._createBindViewModelConfiguration(t),i=ht.CompositionBinder.createBindViewModelResult(n.diContainer,f)};if(u.viewModelName||u.viewModelLocator||o){var t=this+"-["+u.viewModelName+"]",e=u.viewModelInputs,c=Q(null);e&&(h(t),i.inputsWatcherConfig&&(c=ht.CompositionBinder.loadOnInputsSetParameters(i.inputsWatcherConfig)));this._extensionViewModel=c.then((function(t){e&&(n.earlyOnInputsSet=!!t);var r=ni.provideContext((function(){return n._creationState=ni.getState(),o?n._bladeViewModelDeferred.promise:n._viewModelManager.getViewModel(n.extension.name,u.viewModelLocator||u.viewModelName,68,{onInputsSetParameters:t})}),pi.Blade,nr(n));return(ni.provideContext((function(){n._masterBladeState=ni.getState()}),pi.Blade,n.masterContainer?nr(n.masterContainer):null),t)?r.then((function(n){return ht.CompositionBinder.notifyOnInputsSetCalled(i.inputsWatcherConfig,t,n.onInputsSetPromise),n})):r})).then((function(s){var nt=n+"-[WidgetModel]",c=s.content(),k,y,a;if(n._extensionViewModel=s,k=ko.unwrap(s.onInputsSetPromiseState),k&&(n._perfData.onInputsSetPromiseState=k.state,n._perfData.onInputsSetPromiseType=at.OnInputsSetPromiseType[k.type]),n.isDisposed())return n._releaseResources(),Q.reject(new MsPortalFx.Errors.DisposedCanceledError);if(!n.isDisabled){y=s.container;ko.reactor(n,[y.notFoundMessage,y._msPortalFxHandledError,y.unauthorizedMessage,],(function(){var f=y.notFoundMessage(),e=y._msPortalFxHandledError(),t=y.unauthorizedMessage(),o,l;if(MsPortalFx.isNullOrWhiteSpace(du(f)))if(ti(t))ti(e)||n._renderError(e,{});else{var a=n.widget.options,s=ri.unauthorizedMessage,h=a.subtitle(),c=MsPortalFx.isObject(t),i=c?t:{},v=!c&&t!==MsPortalFx.Resources.Strings.ViewModels.Container.unauthorizedText?t:i.noticeDescription||ri.unauthorizedDescription,p={noticeHeader:i.noticeHeader||ri.unauthorizedHeader,noticeTitle:i.noticeTitle||ri.unauthorizedMessage,noticeDescription:v,noticeCallToActionText:i.noticeCallToActionText||"",noticeCallToActionUri:i.noticeCallToActionUri||"",noticeImageType:3,bladeTitle:s,bladeSubtitle:h,shouldDisableBlade:!0},u={bladeTitle:s,bladeSubtitle:h,fallbackErrorCode:403};typeof t=="string"?n._renderError(t,u):ti(t.message)?(l="<p class='msportalfx-notice-header' data-bind='text: $data.noticeHeader'><\/p><p class='msportalfx-notice-title' data-bind='text: $data.noticeTitle'><\/p><p class='msportalfx-notice-description' data-bind='sanitizedHtml: $data.noticeDescription'><\/p><a class='msportalfx-notice-action' target=\"_blank\" data-bind='attr: { href: $data.noticeCallToActionUri }, visible: $data.noticeCallToActionUri'><span class='msportalfx-notice-secondary-action-text' data-bind='text: $data.noticeCallToActionText'><\/span><\/a>",n._renderError({message:{htmlTemplate:l,viewModel:p}},u)):n._renderError(t,u)}else o=r.Container.notFound,n._renderError(f,{bladeTitle:o,bladeSubtitle:"",fallbackErrorCode:404})}));e||o||(n._initialOnInputsSetDeferred.resolve(),n._lastInputsSetDeferred.resolve());e?(f||h(t),f.bindableTarget.viewModel=s,i.inputsWatcherConfig&&ht.CompositionBinder.setupAllInputsSetWatcherFromExtendedConfig(i.inputsWatcherConfig),n._bindingsToExtensionViewModel=i.propertyBindings,n._bindingResult(i)):n._hasPermissionsDeferred.resolve();var tt=n.containerWidget.options,l=n.widget.options,v=n._bindingsToBladeWidgetModel=new vt.PropertyBindings(nt,{title:l.title,subtitle:l.subtitle,titleSuffix:l.titleSuffix,subtitleSuffix:l.subtitleSuffix,description:l.description,helpUri:l.helpUri,icon:l.icon,titleImageUri:tt.titleImageUri,contentState:l.contentState,contentStateDisplayText:l.contentStateDisplayText});ko.reactor(n,(function(){l.shieldType(n.shieldType())}));ko.reactor(n,(function(){l.isUiBlocked(n.uiBlockers().some((function(n){return n()})))}));var p=void 0,d=void 0,g=n._selectedMenuItemIcon();tr(u)?(p=au(n,c,g),d=null):(p=c,g&&ko.isObservable(p.icon)&&MsPortalFx.deepEquals(p.icon(),b.defaultSvg)&&p.icon(g),d=b.defaultSvg);a=w.widgetProperties;dt(v,t,c,a.title,n.title,w.getDefaultTitle(n.locator.name));dt(v,t,c,a.subtitle,n.subtitle,"");dt(v,t,c,a.titleSuffix,n.titleSuffix,"","titleSuffix",!0);dt(v,t,c,a.subtitleSuffix,n.subtitleSuffix,"","subtitleSuffix",!0);dt(v,t,c,a.description,n.description,"");dt(v,t,c,a.helpUri,n.helpUri,"");dt(v,t,p,a.icon,n.icon,d);dt(v,t,c,a.titleImageUri,n.titleImageUri,undefined);c.statusBar?n._onStatusBarClick=yu(n,c.statusBar,n.widget.options,n._isOpenedByReferrer):(dt(v,t,c,a.contentState,ko.observable(0),0),dt(v,t,c,a.contentStateDisplayText,ko.observable(""),""));ko.reactor(n,(function(){var n=l.icon(),t=tr(u)?!n:MsPortalFx.deepEquals(n,b.defaultSvg);l.hasIcon(!t)}))}return s})).catch((function(t){var i="Unable to get extension view model for blade '"+n.locator.toString()+"'. Error: "+MsPortalFx.getLogFriendlyMessage(t);return ei.Error.isBaseOf(t)&&t.errorLevel===0||wt.error(i),s.options.title(w.getDefaultTitle(n.locator.name)),n._hasPermissionsDeferred.resolve(),Q.reject(new ei.CanceledError(i))}))}else s.options.title(w.getDefaultTitle(this.locator.name)),this._initialOnInputsSetDeferred.resolve(),this._hasPermissionsDeferred.resolve()},f.prototype._createBindViewModelConfiguration=function(n){var t=this;return{bindableTarget:{viewModelName:n},inputs:this.bladeDefinition.viewModelInputs,referenceComposition:this,inputsSetCalled:function(n,i){i.finally((function(){($.isEmptyObject(t._lastInputsSetProperties)||ut.deepSubset(n,t._lastInputsSetProperties))&&t._lastInputsSetDeferred.resolve();t._initialOnInputsSetDeferred.resolve()}))},customInputBindingValidator:function(n){if(n.valuesFrom[0].referenceType!==1&&n.valuesFrom[0].referenceType!==5&&!n.optional)return"Blade view model binding can only use 'BladeInput' and 'Constant' reference types."},beforeViewModelPropertyUpdate:function(n){var i=t.bladeDefinition,r;return((i.optionalInputs||[]).forEach((function(t){n[t]===undefined&&delete n[t]})),i.permissions&&!ut.bladeImplementedWithVirtualPart(i))?(r=t.locator.toString(),yt.checkPermissions(i.permissions,nu.All,n,i.assetType,t.extension.name,t.diContainer,r).then((function(n){return t._updateForHasPermissions(n).then(null,(function(n){wt.error(n)})),n}))):(t._hasPermissionsDeferred.resolve(),Q(!0))}}},f.prototype._setupPreviewListener=function(n,t){var u=this,i=this.containerWidget.options,r;this.diContainer.get(s.ManifestCache).getManifest(n.name,"assetTypes").isPreview?i.showPreviewTag(!0):t.assetType?(r=this.diContainer.get(a.AssetTypeService),uu(r.assetTypesComplete,(function(){var u=r.getAssetType(n.name,t.assetType);u&&i.showPreviewTag(u.isPreview)}))):Q(this._extensionViewModel).then((function(n){if(n){var t=n.container;t.preview.subscribe(u,i.showPreviewTag);i.showPreviewTag(t.preview())}}))},f.prototype._renderNotice=function(n){var r,u,f,t,i;if(!ut.bladeImplementedWithVirtualPart(this.bladeDefinition))for(r=this.children.length-1;r>=0;r--)this.removeChild(this.children[r]);u=this.containerWidget;f=u&&u.options;f&&(t=this.widget.options,t.contentState(0),t.contentStateDisplayText(""),n.bladeTitle!==undefined&&t.title(n.bladeTitle),n.bladeSubtitle!==undefined&&t.subtitle(n.bladeSubtitle),t.titleSuffix(""),t.subtitleSuffix(""),vr(u,t,this.bladeDefinition),i=new ru(this.widget.ltm||this),i.header(n.noticeHeader),i.title(n.noticeTitle),i.description(n.noticeDescription),i.imageType(n.noticeImageType),i.callToActionText(n.noticeCallToActionText),i.callToActionUri(n.noticeCallToActionUri),t.noticeTmplVm(i),c.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget));n.shouldDisableBlade&&(this._disabled=!0,this.bindings=[],this._releaseResources());this._compositionDeferred.resolve()},f.prototype._renderError=function(n,t){var r=this.locator,u,s,f,h,i;if(this.bladeDefinition=this.bladeDefinition||{name:r&&r.name,lenses:[],locked:!0},!ut.bladeImplementedWithVirtualPart(this.bladeDefinition))for(u=this.children.length-1;u>=0;u--)this.removeChild(this.children[u]);if(s=typeof n=="string"?{message:n}:n,f=this.containerWidget,h=f&&f.options,h){i=this.widget.options;wu(i);vr(f,i,this.bladeDefinition);t.bladeTitle!==undefined&&i.title(t.bladeTitle);t.bladeSubtitle!==undefined&&i.subtitle(t.bladeSubtitle);var l=new k.ViewModel(s,{sessionId:MsPortalFx.sessionId,extName:this.extension&&this.extension.name||this.locator&&this.locator.getExtensionName(),contentName:r&&r.name,resourceId:this._findResourceId(),code:t.fallbackErrorCode}),a=new nt.CompositionInstanceCommandContext($(this.containerWidget.element)[0],null,this),o=new it.GoToAssetBlade(this,this._diContainer,this);o&&(o.bind(a),o.enabled()&&l.commands.push(o));i.errorTmplVm(l);c.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)}this.getDeepLink().then((function(n){n&&n!==location.href&&e.history_pushState(null,s.message,n)}));this._disabled=!0;this._releaseResources()},f.prototype._disposeEditScopes=function(){var r=this,i=this.editScopeId(),n,t;if(i)this.diContainer.get(v.EditScopeManager).onEditScopeDisposed(i);n=this._journey;n&&(t=this.journeyPath,n.ambientSettings.getItemsInPath(t).forEach((function(n){if(n.value&&n.value.editScope)r.diContainer.get(v.EditScopeManager).onEditScopeDisposed(n.value.editScope.editScopeId)})),n.ambientSettings.removeItemsInPath(t))},f.prototype._clearEditScopeId=function(){if(this.bladeDefinition.editScopeType){var n=this.editScopeId(),t=n&&this.diContainer.get(v.EditScopeManager).getStateObservable(n);if(t&&t()===0)this.diContainer.get(v.EditScopeManager).onEditScopeDisposed(n);this.editScopeId(undefined);this._shellViewModel[ut.EditScopeIdPropertyName](undefined)}},f.prototype._createChildrenFromDefinition=function(n){var i=this,t;this._childrenCreated||(n.lenses&&(t=[],n.lenses.forEach((function(r){var f=i.locator.withLens(r.name),u=lt.create(i.diContainer,f,n.locked&&i._sequenceNumber);r.isSummary?t.unshift(u):t.push(u)})),this.addChildren(t)),this._childrenCreated=!0)},f.prototype._removeRedirectParts=function(){var n=this,t=this.children.filter((function(t){var i=t.children.filter((function(t){var i={},r=n._finder.tryLocate(t.locator,i),u=i.value;return r&&!!u.redirectMode})),r=t.children.length&&i.length===t.children.length;return i.forEach((function(n){t.removeChild(n)})),r}));t.forEach((function(t){n.removeChild(t)}))},f.prototype._composeChildren=function(n){var t=this,o;n===void 0&&(n=this.children);var r=[],i=[],f=this._summaryCollapsed(),e,u=0;MsPortalFx.isFeatureEnabled("bladefullreadytimeout")&&(o=function(){var n=MsPortalFx.extend({resourceId:t._findResourceId(),partStates:e},t._perfData);t._trace({action:"BladeLoadErrored",actionModifier:bt[bt.FullReadyTimeout],data:n,duration:u})},u=setTimeout(o,ot.bladeFullReadyTimeout));n&&n.length&&n.forEach((function(n){f.then((function(u){t._bladeSummaryCollapsed=u;n.compose(t.widget);r.push(n.await(7));i.push(n.await(3));n.children.concat([n]).forEach((function(n){r.push(n.await(7));i.push(n.await(3))}))}))}));f.finally((function(){Q.all(r).then((function(){t._perfData.bladeOpenedTime=ur()-t._telemetry.readyStartTime})).finally((function(){t._composing=!1;t.save()}));cr(t,Q.allSettled(i)).then((function(n){e=n;t._telemetry.traceBladeComplete(n,u,ci(t));c.FocusHandler.Instance.notifyContainerReadyForFocus(t.widget)}));Q.all(i).then((function(){t.bladeDefinition.menuBlade||t._announce.read(ui.bladeReady)}));Q.allSettled(i).then((function(){var n=t.getParts();Q.allSettled(__spreadArray([],n.map((function(n){return t.notifyPartComposed(n)})))).then((function(){t.containerWidget.options.printEnabled(n.every((function(n){var r=!0,t,i;return n.definitionExists&&(t=MsPortalFx.Parts.PartKind,i=n.partDefinition&&n.partDefinition.partKind,r=i!==t.Frame&&i!==t._Internal_App&&i!==t._Internal_Az),r})))}))}))}))},f.prototype.getPerfData=function(){return MsPortalFx.extend2(this._perfData,this.menu&&this.menu.getTelemetryInfo())},f.prototype._composeAndRestoreLayout=function(){var n=this,r=this.containerWidget,t,i,u;return this._removeRedirectParts(),this._composeChildren(),t=Q(),i=this.bladeDefinition.actionBar,!this._rebinding&&i&&(u=this.locator.withBladeActionBar(i.name),t=MsPortalFx.tryImmediateResolve(MsPortalFx.require("MsPortalImpl/UI/Compositions/UI.Composition.BladeActionBar"),(function(t){var i=n.actionBar=t.create(n.diContainer,u);i.parent=n;i.compose(n.widget);n.registerForDispose(n.actionBar)}))),r.options.displayState()===2&&r.refreshDisplayState(),t},f.prototype._getCommands=function(){if(!this.isComposed||!this.widget)throw new Error("Blade '"+this+"' needs to be composed before retrieving its commands.");return this.widget.options.commandBar.menuItems()},f.prototype._attachEventHandlers=function(n,t,i,r,u,f){var e=this,l=n.element,c=t.element,o=n.options,s,h;if(!i){c.on("fxregistermenu",(function(t,i){var r="Default",u=ii(e.locator);i.onItemClick((function(n,t){e._trace({action:"MenuItemClick",actionModifier:r,data:$.extend({blade:u,type:i.getResourceType()||e.assetType},t),source:"Blade",name:n})}));i.setDefaultId({recommendedId:e.defaultMenuItemId,bladeReference:e.contentBladeReference});i.onSearchMiss((function(n){ni.usingState((function(){e._trace({action:"MenuBladeSearchMiss",actionModifier:r,data:$.extend({blade:u,type:i.getResourceType()||e.assetType},n),source:"Blade"})}),e._creationState)}));e.await(4).finally((function(){var n=i.getResourceType()||e.assetType;ni.usingState((function(){var t=$.extend({blade:ii(e.locator),type:n},i.getTelemetryInfo());e._trace({action:"MenuBladeInfo",actionModifier:r,data:t,source:"Blade"})}),e._creationState);n&&o.associatedWithAsset(!0)}));ko.reactor(e,(function(){n.options.titleSuffix(i.selectedItemText())}));MsPortalFx.isFeatureEnabled("earlymenucontentvm")&&i.delayRendering(e._resumeMenuRenderingDeferred.promise);e.menu=i}));o.close=function(){var t=gt(e.diContainer),i=t.tryCloseBlade(e,1),n,u;return i&&r&&(n=t.activeJourney().children,u=n[n.length-1],u.menu.selectDefaultItem()),i};o.pinblade=function(){s&&s.dispose();s=e.createChildLifetime();var t=new tt.Pin(s,e.diContainer);t.bind(new nt.CompositionInstanceCommandContext(n.element[0],function(){return Q(n.getContentWidget())},e));t.execute(!1)};h=new tt.Edit(this.createChildLifetime(),this.diContainer,function(n){o.editState(n)});o.editblade=function(){h.bind(new nt.CompositionInstanceCommandContext(n.element[0],function(){return Q(n.getContentWidget())},e));h.execute(!1)};o.resetEditCommand=function(){h.reset()};u&&f&&f.clearDetailContent()}t.options.commandBar.itemSelected=function(n,i){var r=i.item,f,o,u;r&&r.enabled()&&!r.unauthorized()&&(f=i.popupTarget,o=f?{getForm:function(){return f},showForm:MsPortalFx.noop,hideForm:MsPortalFx.noop}:t,r.bind(new nt.CompositionInstanceCommandContext(t.element[0],function(){return Q(o)},e)),r.execute(!1),u=i.item.commandDefinition,u&&u.details&&br(e,(function(n){return n.masterCommandName===u.name})))};t.options.commandBar.locator=this.locator;this._disposablesEvents.push(c.setEvents([d.Widget.viewSettingsChanged,function(n,t){e.widgetState(t);e.save(1);n.stopPropagation()},],["fxbladestatusbarclicked",function(){e._onStatusBarClick&&e._onStatusBarClick()},]),l.setEvents(["fxensurebladevisible",function(n,t){br(e,(function(n){return!n.masterCommandName&&n.masterPartId===t.masterPartId}))},],["fxsummarycollapsed",function(n,t){t.collapsed=e._bladeSummaryCollapsed},],["fxgotodefaultitem",function(){e.menu&&e.menu.selectDefaultItem()},]))},f.prototype._composeShellCommands=function(n,t,i){var e=[],u=this.diContainer,r=this.containerWidget.options;if(this.isPinnable()){var f=this.bladeDefinition,o=ut.getBladeType(f),s=o===5||o===6,h=new tt.Pin(this,u);r.pinVisible(!s);f&&f.hasOnPinMethod?this.getOnPinFunction().then((function(n){n&&(s&&r.pinVisible(!0),h.activate(),r.pinEnabled(!0))})):(h.activate(),r.pinEnabled(!0))}r.resetEditCommand(null);this.isEditable()&&(r.editVisible(!0),r.editEnabled(!0));e.push(tt.getDisplayStateCommand(u,1),new tt.ResetLayout(this,u,t,i));sr.arrayPushAll(n,e)},f.prototype._validateParameters=function(t,i,r){var l=this.getViewModel(),o=(i.inputs||[]).filter((function(n){return!vt.getModelValue(l,n).exists})),e,c;if(o.length){if(e=void 0,this.masterPartId){var f=MsPortalFx.find(this.masterContainer.getComposedParts(),ut.getIdMatchFunc(this.masterPartId)),h=this.diContainer.get(ct.Finder).findPartsContainer(f),s=f&&f.partDefinition&&f.partDefinition.shareVmWithParentBlade?h&&h.locator:f&&f.locator;e="The "+(s.type===1?"blade":"part")+" "+ii(s)+" failed to supply all the required parameters. The missing the required parameter(s) '"+o.join(", ")+"'.";c="Failed to open the blade "+ii(this.locator)+". "+e;u.logToExtension(n,hi(s),2,c)}else e="The link '"+this.openedByInfo.openedByContext.deepLink+"' is missing the required parameter(s) '"+o.join(", ")+"'.";this._composeErrorBlade(t,r,bt.ErrorInitializing,e)}return!o.length},f.prototype._validateDefinition=function(n,t,i){var e=this,r=!0,u=[],f="A blade cannot be the owner of an edit scope and also receive an edit scope id from an external source.";return t.assetType&&!t.assetIdInputProperty?(u.push("'assetIdInputProperty' is required if 'assetType' is defined on blade definition."),r=!1):t.inputs&&t.outputs&&(r=!t.inputs.some((function(n){var i=t.outputs.indexOf(n)>=0;return i&&u.push("Property '"+n+"' cannot be marked as input and output."),i}))),r=r&&ht.CompositionBinder.validateInputBindings(this,t.bindings,u,(function(n){return n.valuesFrom[0].referenceType===1?"Blade bindings cannot reference BladeInputs.":li(t.inputs)&&t.inputs.indexOf(n.property)>=0?"Blade bindings that target a blade input are not supported. Inputs: '"+oi(t.inputs)+"'. Bindings: '"+oi(t.bindings)+"'.":!!t.editScopeType&&n.property===ut.EditScopeIdPropertyName?"Declaring an 'editScopeType' and an input binding with '"+ut.EditScopeIdPropertyName+"' as a target property is not supported. "+f+" Bindings: "+vi(e.bindings):void 0})),r&&!!t.editScopeType&&li(this.masterInputKeys)&&this.masterInputKeys.indexOf(ut.EditScopeIdPropertyName)>=0&&(r=!1,u.push("Declaring an 'editScopeType' and receiving an '"+ut.EditScopeIdPropertyName+"' from invocation values is not supported. "+f+(" Invocation Properties: "+vi(this.masterInputKeys)+"."))),r&&ht.CompositionBinder.modelHasPropertiesWithValue(this+"",t.templateKeyInputs,this.getViewModel()),u.length&&wt.error(u[0]+" Blade:'"+this.locator+"'."),r||this._composeErrorBlade(n,i,bt.ErrorInitializing,"Unable to initialize blade from definition."),r},f.prototype._findResourceId=function(){return this.assetId()||this.parent&&this.parent.getCurrentResourceId()},f})(ft.Instance);t.Instance=yi}))