define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/CloudService.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Strings","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider"],(function(n,t,i,r,u,f){"use strict";function e(n){var t=[],i=n&&n.properties&&n.properties.deploymentSlots||[],r=i.length>=2;return i.forEach((function(n){if(!r||n.name!=="Staging"){var i=n&&n.properties&&n.properties.roles;i&&i.forEach((function(n){t.push({id:n.name,displayName:n.name})}))}})),t}Object.defineProperty(t,"__esModule",{value:!0});t.CloudServiceProvider=t.RolesPrefix=void 0;t.RolesPrefix="/slots/production/roles/";var o=(function(n){function f(t,i,r){var u=n.call(this,t,i,r)||this;return u.id=4,u._roleCache={},u}return __extends(f,n),f.prototype.getNamespaces=function(f,o){var s=[],h=[],c=this._roleCache[this._resId],l;return!c||c.isRejected()||o?(l=this._ajax.fetchArm(""+this._resId+"?$expand=deploymentSlots/roles/instances&api-version=2015-06-01",this._resId,"CloudService_NS",f).then((function(n){return e(n).forEach((function(n){s.push({name:""+t.RolesPrefix+n.id,displayName:n.id,category:r.NamespaceOptionType.Standard})})),s})),this._roleCache[this._resId]=l,h.push(l)):h.push(c),h.push(n.prototype.getNamespaces.call(this,f,o).then((function(n){return n.forEach((function(n){n.category!==r.NamespaceOptionType.Standard&&s.push(n)})),n}))),u.resolveIfAnySucceed(h).then((function(){return s.length===0?[{name:i.noRolesMessage,category:r.NamespaceOptionType.Standard}]:s}))},f})(f.MdmV2Provider);t.CloudServiceProvider=o}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/CosmosDB.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider"],(function(n,t,i,r,u,f){"use strict";function e(n){return!(n&&n.namespace===r.ClassicCosmosDBNamespace)||!!n.crossResource}Object.defineProperty(t,"__esModule",{value:!0});t.CosmosDBProvider=void 0;var o=(function(n){function t(t,i,r){var u=n.call(this,t,i,r)||this;return u._legacyProviderDefer=Q.defer(),u.id=6,u}return __extends(t,n),t.prototype.getMetricDefinitions=function(t,u,f){return u===r.ClassicCosmosDBNamespace?(this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,this._resDef,this._ajax,this._telemetry),this._legacyProviderDefer.promise.then((function(n){return n.getMetricDefinitions(t,u)}))):n.prototype.getMetricDefinitions.call(this,t,u,f)},t.prototype.getMetricResults=function(t,r){var h=t.metrics||[],s=[],o=[],f;return h.forEach((function(n){e(n)?s.push(n):o.push(n)})),f=[],t.metrics=s,f.push(n.prototype.getMetricResults.call(this,t,r)),o.length>0?(t.metrics=o,this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,this._resDef,this._ajax,this._telemetry),this._legacyProviderDefer.promise.then((function(n){return f.push(n.getMetricResults(t,r)),u.joinAggregatePromises(f)}))):u.joinAggregatePromises(f)},t.prototype.getDimensionDefinitions=function(t,i,r){return n.prototype.getDimensionDefinitions.call(this,t&&t.filter(e),i,r)},t.prototype.getDimensionValues=function(t,i,r,u,f,o){return n.prototype.getDimensionValues.call(this,t&&t.filter(e),i,r,u,f,o)},t})(f.MdmV2Provider);t.CosmosDBProvider=o}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/Storage.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider"],(function(n,t,i,r,u,f,e){"use strict";function c(n,t){var i={};return n.forEach((function(n){var r=n.namespace&&s[n.namespace.toLowerCase().substr(t)]||h;i[r]||(i[r]=[]);i[r].push(n)})),i}Object.defineProperty(t,"__esModule",{value:!0});t.StorageProvider=void 0;var o="/services/",l=[{value:"legacyBlob",resourceIdSuffix:o+"blob"},{value:"legacyFile",resourceIdSuffix:o+"file"},{value:"legacyQueue",resourceIdSuffix:o+"queue"},{value:"legacyTable",resourceIdSuffix:o+"table"},],a=[{value:"account",resourceIdSuffix:""},{value:"blob",resourceIdSuffix:"/blobServices/default"},{value:"file",resourceIdSuffix:"/fileServices/default"},{value:"queue",resourceIdSuffix:"/queueServices/default"},{value:"table",resourceIdSuffix:"/tableServices/default"},],s={"":"account","/blobservices":"blob","/fileservices":"file","/queueservices":"queue","/tableservices":"table","/services/blob":"legacyBlob","/services/file":"legacyFile","/services/queue":"legacyQueue","/services/table":"legacyTable"},h="account",v=(function(){function n(n,t,i){var r=this;this.id=12;this._legacyProviderDefer=Q.defer();this._mdm={};this._legacy={};this._resDef=n;this._ajax=t;this._telemetry=i;u.isResourceDefinition(n)&&(this._resId=n.id,this._resType=u.getResourceProvider(this._resId));a.forEach((function(u){r._resId&&(n={id:r._resId+u.resourceIdSuffix});r._mdm[u.value]={value:u.value,resourceIdSuffix:u.resourceIdSuffix,provider:new e.MdmV2Provider(n,t,i)}}))}return n.prototype.getLegacySubProviders=function(){var n=this;return this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,this._resDef,this._ajax,this._telemetry),this._legacyProviderDefer.promise.then((function(t){return l.forEach((function(i){n._legacy[i.value]={value:i.value,resourceIdSuffix:i.resourceIdSuffix,provider:t}})),n._legacy}))},n.prototype._fetchMetricResults=function(n,t,i){var r=this,u=[];return Object.keys(n).forEach((function(f){var e=f.indexOf("legacy")===0?r._legacy:r._mdm;Object.keys(e).forEach((function(o){if(o===f){t.metrics=n[f];var s=e[o].provider.getMetricResults(t,i).then((function(n){return n.forEach((function(n){n&&(n.metric.resourceId=r._resId)})),n}));u.push(s)}}))})),f.joinAggregatePromises(u)},n.prototype.getNamespaces=function(n,t){var i=u.getDefaultNamespaces(this._resId),f=this._mdm[h];return f.provider.getNamespaces(n,t).then((function(n){var t=n&&n.filter((function(n){return n.name!==r.ResourceTypes.Storage&&n.name!==r.ResourceTypes.StorageClassic}));return i.concat(t)}))},n.prototype.getMetricDefinitions=function(n,t,i){var e=this,o=[],r=t&&s[t.substr(this._resType.length)],h=!t||r&&r.indexOf("legacy")>=0,c=h?this.getLegacySubProviders():Q(this._mdm);return c.then((function(s){var h=s;return Object.keys(h).forEach((function(f){var c=r&&h[r],s,l;c&&c.value!==f||(s=h[f],t||(t=""+e._resType+s.resourceIdSuffix),l=s.provider.getMetricDefinitions(n,t,i).then((function(n){return n.forEach((function(n){var t=n.metricId;u.isResourceDefinition(t.resourceDefinition)&&(t.resourceDefinition.id=e._resId);t.name.displayName||(t.name.displayName=t.name.id)})),n})),o.push(l))})),f.joinAggregatePromises(o)}))},n.prototype.getDimensionDefinitions=function(n,t,i){var o=this,u=[],r=[],e=c(n,this._resType.length);return Object.keys(e).forEach((function(n){var f=o._mdm[n],s,h;f&&(s=e[n],h=f.provider.getDimensionDefinitions(s,t,i).then((function(n){return r=r.concat(n),n})),u.push(h))})),f.resolveIfAnySucceed(u).then((function(){return r}))},n.prototype.getDimensionValues=function(n,t,i,r,u,e){var s=this,o=c(n,this._resType.length);return f.joinAggregatePromises(Object.keys(o).map((function(n){var f=s._mdm[n];if(f)return f.provider.getDimensionValues(o[n],t,i,r,u,e)})))},n.prototype.getMetricResults=function(n,t){var r=this,i={},f=n.metrics,u;return f.forEach((function(n){var u=n.namespace&&n.namespace.toLowerCase(),t=u&&s[u.substr(r._resType.length)]||h;i[t]||(i[t]=[]);i[t].push(n)})),u=Object.keys(i).some((function(n){return n.indexOf("legacy")===0})),u?this.getLegacySubProviders().then((function(){return r._fetchMetricResults(i,n,t)})):this._fetchMetricResults(i,n,t)},n})();t.StorageProvider=v}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/VirtualMachine.Provider",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider"],(function(n,t,i,r,u,f,e){"use strict";function o(n){return n&&c.some((function(t){return t===n.toLowerCase()}))}function s(n){return""+n+r.VMGuestSuffix}function h(n,t){return n.map((function(n){return n.metricId.namespace={name:s(t)},n}))}Object.defineProperty(t,"__esModule",{value:!0});t.VirtualMachineProvider=t.VMDEV=void 0;var c=["microsoft.compute/virtualmachines/guest","microsoft.compute/virtualmachinescalesets/guest","microsoft.classiccompute/virtualmachines/guest",],l=(function(){function n(n,t,i){this.id=13;this._legacyProviderDefer=Q.defer();u.isResourceDefinition(n)?(this._resId=n.id,this._resType=u.getResourceProvider(this._resId)):(this._resId=n.subscription.subscriptionId,this._resType=n.resourceType,this._isCrossRes=!0);this._resDef=n;this._telemetry=i;this._ajax=t;this._mdm=new e.MdmV2Provider(n,this._ajax,i);this._legacyDefs=[]}return n.prototype.getNamespaces=function(n,t){var u=this,f;return this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,this._resDef,this._ajax,this._telemetry),f=[this._legacyProviderDefer.promise.then((function(i){return i.getMetricDefinitions(n,u._resType,t)})),this._mdm.getNamespaces(n,t),],Q.allSettled(f).then((function(n){var i=[],t;if(n[1]&&n[1].state==="fulfilled")return n[1].value.forEach((function(n){i.push(n)})),n[0]&&!u._isCrossRes&&(t=n[0].state==="fulfilled",t&&(u._legacyDefs=h(n[0].value,u._resType)),u._resType!==r.ResourceTypes.ClassicComputeVirtualMachines&&(t&&u._legacyDefs.length>0||!t)&&i.push({name:s(u._resType),category:t?r.NamespaceOptionType.Custom:r.NamespaceOptionType.Error})),i}))},n.prototype.getMetricDefinitions=function(n,t,r){var c=this,u=[],e=o(t),s;return(!t||e)&&(this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,this._resDef,this._ajax,this._telemetry),s=this._legacyProviderDefer.promise.then((function(i){return i.getMetricDefinitions(n,t,r).then((function(n){return h(n,c._resType)}))})),u.push(s)),e||u.push(this._mdm.getMetricDefinitions(n,t,r)),f.joinAggregatePromises(u)},n.prototype.getDimensionDefinitions=function(n,t,i){return this._mdm.getDimensionDefinitions(n.filter((function(n){return!o(n.namespace)}))||[],t,i)},n.prototype.getDimensionValues=function(n,t,i,r,u,f){return this._mdm.getDimensionValues(n.filter((function(n){return!o(n.namespace)}))||[],t,i,r,u,f)},n.prototype.getMetricResults=function(n,t){var s=n.metrics,h=n.filters,u,e,r;return!s||s.length===0||!n.timerange?Q([]):(u=[],e=[],s.forEach((function(n){n.namespace&&o(n.namespace)?e.push(n):u.push(n)})),r=[],u.length>0&&(n.metrics=u,r.push(this._mdm.getMetricResults(n,t))),e.length>0&&(!h||h.length===0))?(n.metrics=e,this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,this._resDef,this._ajax,this._telemetry),this._legacyProviderDefer.promise.then((function(i){return r.push(i.getMetricResults(n,t)),f.joinAggregatePromises(r)}))):f.joinAggregatePromises(r)},n})();t.VirtualMachineProvider=l}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/Root.ProviderFactory",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/MappedUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Shared/AjaxHelper","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Telemetry","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/AppInsight.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/CloudService.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/CosmosDB.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/MdmV2.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/Storage.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/VirtualMachine.Provider"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.RootProviderFactory=void 0;var y={"microsoft.insights/components":s.AppInsightProvider,"microsoft.storage/storageaccounts":a.StorageProvider,"microsoft.classicstorage/storageaccounts":a.StorageProvider,"microsoft.compute/virtualmachines":v.VirtualMachineProvider,"microsoft.compute/virtualmachinescalesets":v.VirtualMachineProvider,"microsoft.classiccompute/virtualmachines":v.VirtualMachineProvider,"microsoft.classiccompute/domainnames":h.CloudServiceProvider,"microsoft.documentdb/databaseaccounts":c.CosmosDBProvider},p=(function(){function n(n,t){this._legacyProviderDefer=Q.defer();this._telemetry=n;this.ajax=t||new f.Ajax}return n.prototype.getProvider=function(n,t){var h=this,e,f,s;return(o.isResourceDefinition(n)?(s=n.id,f=n.id===u.DraftDEMOAPPAppId?u.ResourceTypes.ApplicationInsights:o.getResourceProvider(s)):(f=n.resourceType,s="/subscriptions/"+(n.subscription&&n.subscription.subscriptionId)),f===u.ResourceTypes.ContainerInsights?e=this.getProviderForContainerInsights(s,n,t):f==="microsoft.customerinsights/hubs"||f==="microsoft.insights/webtests"?(this._legacyProviderCreated=this._legacyProviderCreated?this._legacyProviderCreated:i.loadLegacyProvider(this._legacyProviderDefer,this._legacyProviderCreated,n,this.ajax,this._telemetry),e=this._legacyProviderDefer.promise):e=Q(y[f]?new y[f](n,this.ajax,this._telemetry):new l.MdmV2Provider(n,this.ajax,this._telemetry)),r.isFeatureFlagEnabled("dualquery"))?Q.spread([i.dynamicImport("../AI/ME/MetricsProvider/BackendProviders/Dual.Provider"),e],(function(t,i){return t.CreateProvider(n,h.ajax,i)})):e},n.prototype.getProviderForContainerInsights=function(n,t,r){var f=this,o=n+"/?api-version=2019-02-01";return this.ajax.fetchArm(o,n,u.QueryNames.GetContainerInsightsResource,r,"GET").then((function(r){var e=r&&r.properties&&r.properties.addonProfiles&&r.properties.addonProfiles.omsagent,u=e&&e.config,o=u&&Object.keys(u).filter((function(n){return(n&&n.toLowerCase())==="loganalyticsworkspaceresourceid"}));if(o.length>0&&u[o[0]])return i.dynamicImport("../AI/ME/MetricsProvider/BackendProviders/ContainerInsights.Provider").then((function(n){return new n.ContainerInsightsProvider(t,f.ajax,f._telemetry)}));throw Error("ContainerInsights cluster is not onboarded for resource "+n);})).catch((function(i){return e.logWarning("getProviderForContainerInsights failed",f._telemetry,{ContainerName:"Root.ProviderFactory.getProviderForContainerInsights",Error:JSON.stringify(i),ResourceId:n}),new l.MdmV2Provider(t,f.ajax,f._telemetry)}))},n})();t.RootProviderFactory=p}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Shared/QueryCache",["require","exports"],(function(n,t){"use strict";function r(n,t){var i,r;if(n&&n.length>0&&!!t)for(i=0;i<n.length;i++)if(r=n[i],t(r))return i;return-1}Object.defineProperty(t,"__esModule",{value:!0});t.AIQueryCache=void 0;var i=(function(){function n(n,t,i,r){r===void 0&&(r=10);this._cache={};this._index=[];this._getKey=n;this._fetch=t;this._getSecondaryKey=i;this._maxSize=r}return n.prototype.fetch=function(n,t){var r=this,u=this._getKey(n),i=this._cache[u],f;return!i&&this._getSecondaryKey&&(f=this._getSecondaryKey(n),i=f&&this._cache[f]),i&&!t?(this._updateCacheWithPromise(u,i),i.isPending()?i.then((function(n){return{cached:!1,cacheSize:r._index.length,result:n}})):i.then((function(n){return{cached:!0,cacheSize:r._index.length,result:n}}))):(i=this._fetch(n,t),this._updateCacheWithPromise(u,i),i.catch((function(){delete r._cache[u]})),i.then((function(n){return{cached:!1,cacheSize:r._index.length,result:n}})))},n.prototype._updateCacheWithPromise=function(n,t){var u=r(this._index,(function(t){return t===n})),f,e,i;if(u!==-1)f=this._index.slice(0,u),e=this._index.slice(u+1),this._index=[n].concat(f,e);else if(this._cache[n]=t,this._index.length===0)this._index.push(n);else if(this._index=[n].concat(this._index),this._index.length>this._maxSize){for(i=this._maxSize-1;i<this._index.length;i++)delete this._cache[this._index[i]];this._index=this._index.slice(0,this._maxSize)}},n})();t.AIQueryCache=i}));
define("MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/MetricsProviderWrapper",["require","exports","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/DynamicImportUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/Utils/MappedUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Constants","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/DataModels/MetricsExplorerItemDataModel","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Shared/QueryCache","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Stores/ItemDataModelStore","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Telemetry","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ChartUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/DateUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/FilterTreeHelper","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/ResourceTypes","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/TimeUtils","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/Utilities/Util","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/CloudService.Provider","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/BackendProviders/Root.ProviderFactory","MsPortalImpl.Controls/Controls/Visualization/MonitorChartV2/AI/ME/MetricsProvider/QueryDataModelUtils"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b){"use strict";function nt(n,t,i,r){return n.map((function(n){return"M="+y.GetUniqueId(n)})).join(";")+";"+t.map((function(n){return"F="+JSON.stringify(n)})).join(";")+";S="+JSON.stringify(i)+";K="+r+";T="}function ht(n,t){var i=s.AddOperation(k+".getMetricResult",n.opTelem),r=i.opTimer,u=i.opStop;return n.opTelem=r,ot.fetch(n,t===1).then((function(n){return n.result})).finally(u)}function ct(n,t){var i=n.metric,r=s.AddOperation(k+".getMetricResultInner",n.opTelem),u=r.opTimer,f=r.opStop;return a.isValidResourceDefinition(i.id.resourceDefinition)?g(n.providerFactory,i.id.resourceDefinition,n.opTelem).then((function(r){var f=b.ToMetricQueryParams(i.id);return f.aggregation=i.metricAggregation,f.nativeDescription=i.nativeDescription,r.getMetricResults({metrics:[f],filters:n.filters,splitBy:n.splitBy,fetchDataKind:n.fetchDataKind,timerange:n.timespan.absolute,isRelativeTime:n.isRelativeTime,timegrain:n.timespan.timeGrain},u,t).then((function(n){return n.map((function(n){return b.HydrateMetricResult(i,n)}))}))})).finally(f):Q.reject({error:"Invalid resourceDefinition"})}function lt(n){var r=Object.keys(d),i,t;if(r.length>=10){if(i=tt.GetUniqueResourceIds(),i[n.id]=!0,Object.keys(i).length>=r.length)return;r.forEach((function(n){i[n]||(!t||d[n].lastVisitTime<d[t].lastVisitTime)&&(t=n)}));t&&delete d[t]}}function rt(n){var t=n.itemDataModel,i=t.visualization,r=i&&i.chartType===4&&i,f={dimensionId:t.grouping&&t.grouping.dimension&&t.grouping.dimension.dimensionName&&t.grouping.dimension.dimensionName.id,sort:r&&r.sortOrder||t.grouping&&t.grouping.sort||2,top:n.segmentedTopCount||u.UniqueDimensionValueThreshold};return{metricList:t.metrics,metricTimeSpan:h.getIdealTimeSpan(n.timeContext,n.opTelem,t.appliedISOGrain),filters:l.createFilterQueryData(t.filters),splitBy:f,fetchDataKind:at(i&&i.chartType,t.IsSegmented()),timeContext:n.timeContext,cause:n.cause}}function at(n,t){var i=n===4;return(t&&8)|(t&&!i&&4)|(!t&&2)|(!t&&!i&&1)}function g(n,t,i){var f;if(!t||!t.id&&!t.subscription)throw new Error(k+".getBackendProvider: Invalid resourceDefinition");var o=s.AddOperation(k+".getBackendProvider",i).opStop,r,e=y.getResourceDefinitionUniqueId(t),u=d[e];return u?(u.lastVisitTime=Date.now(),r=u.promise):(f=n.getProvider(t,i),d[e]={promise:f,lastVisitTime:Date.now()},t.id&&lt(t),r=f.finally(o)),r}function vt(n,t){var i=n.itemDataModel,c=n.timeContext,o=n.opTelem,r,f,w,l,ft;if(!i||!i.metrics||i.metrics.length===0)return Q({});r=rt(n);r.metricList=[];f=y.cloneProperties(r);t&&(r.cause=1,f.cause=1);i.metrics.forEach((function(n){a.isMetricLegacy(n.id.namespace&&n.id.namespace.name)?f.metricList.push(n):r.metricList.push(n)}));var b=i.appliedISOGrain,d=Q([]),g=r.metricList.length,nt=f.metricList.length,ut=b||(nt>0&&g>0&&c&&c.getGrain()===1?"PT1H":undefined);g>0&&(d=n.provider.setupTimespan(r.metricList,c,o,null,ut).then((function(t){return r.metricTimeSpan=t,pt(o,n.provider.providerFactory,r)})));w=Q([]);nt>0&&(ft=function(){var t=y.uniqueObjects(f.metricList.map((function(n){return{resource:n.id.resourceDefinition,namespace:n.id.namespace&&n.id.namespace.name}})),(function(n){return n.resource.id+n.namespace}));return y.joinAggregatePromises(t.map((function(t){return n.provider.fetchMetricDefinitions(t.resource,t.namespace,o,n.cause===1)})))},w=n.provider.setupTimespan(f.metricList,c,o,ft,ut).then((function(t){if(t&&t.timeGrain)return l=i.appliedISOGrain=t.timeGrain,f.metricTimeSpan=t,et(o,n.provider.providerFactory,f)})));var e,p=tt.GetAction(i.id),u={userDataStatus:0},v=s.AddOperation(k+"._fetchMetricResultsInternal.QueryPromises",o);return Q.spread([w,d],(function(t,r){var f,o,a;if(v.opStop(),f=r.map((function(n){return n&&n.timeGrain})),f=y.unique(f),f.length>1){u.userDataStatus=10;u.error={message:"TimeSeries has different grains.",responsetext:"Incompatible grains between metrics. Grains:"+f.toString()};s.logWarning(it,n.provider.telemContext,undefined,undefined,v.opTimer);throw u;}if(o=f.length>0&&f[0],e=o&&l,e){if(o!==l){u.userDataStatus=10;u.error={message:"NoCommonGrain",responsetext:"No common grain between legacy and nonlegacy metric; legacy: "+l+"; nonLegacy: "+o};s.logWarning(it,n.provider.telemContext,undefined,undefined,v.opTimer);throw u;}}else e=o||l;if(a=h.computeTotalDataPoints(c,1,e),!n.ignoreDataPointLimit&&a>1e4){s.logWarning("Too many datapoints.",n.provider.telemContext,{ContainerName:k},{Count:a},v.opTimer);u.userDataStatus=8;u.error={message:"TooManyDataPoint",responsetext:"There are too many data points: "+a};throw u;}return i.appliedISOGrain=e,p&&p.UpdateISOGrain("",e),yt(r.concat(t),i.metrics,e)}),(function(t){p&&p.UpdateISOGrain("",b);s.logError(k+".fetchMetricResults(): error fetching results",n.provider.telemContext,t,undefined,undefined,v.opTimer);throw t;}))}function yt(n,t,i){var r={};return n.forEach((function(n){if(n){n.timeGrain=i;var u=f.findMetricDataModelMatches(n,t);u&&u.length>0&&(r[y.GetUniqueId(u[0])]=n)}})),r}function pt(n,t,u){var f=function(n){return et(n,t,u)};return r.isFeatureFlagEnabled("dualquery")?i.dynamicImport("../AI/ME/MetricsProvider/BackendProviders/Dual.Provider").then((function(i){var r=i.CreateProvider(u.metricList[0].id.resourceDefinition,t.ajax,undefined);return r&&r.getBatchedMetricResults(n,u,f)||f(n)})):f(n)}function et(n,t,i){return y.joinAggregatePromises(i.metricList.map((function(r){var u={providerFactory:t,opTelem:n,metric:r,filters:i.filters,splitBy:i.splitBy,fetchDataKind:i.fetchDataKind,isRelativeTime:i.timeContext.getIsRelative(),timespan:i.metricTimeSpan,looseTimeSpan:h.getLooseTimeSpan(i.metricTimeSpan,i.timeContext,i.cause,n)};return ht(u,i.cause)})))}var ft;Object.defineProperty(t,"__esModule",{value:!0});t.MetricsProviderWrapper=void 0;var ot=new e.AIQueryCache(function(n){return nt([n.metric],n.filters,n.splitBy,n.fetchDataKind)+JSON.stringify(n.timespan)},function(n,t){return ct(n,t)},function(n){return n&&n.looseTimeSpan&&nt([n.metric],n.filters,n.splitBy,n.fetchDataKind)+JSON.stringify(n.looseTimeSpan)},15),st=new e.AIQueryCache(function(n){var t=rt(n);return nt(t.metricList,t.filters,t.splitBy,t.fetchDataKind)+JSON.stringify(t.metricTimeSpan)},function(n,t){return vt(n,t)},function(n){var t=rt(n);return nt(t.metricList,t.filters,t.splitBy,t.fetchDataKind)+JSON.stringify(h.getLooseTimeSpan(t.metricTimeSpan,t.timeContext,t.cause,new s.OperationTelemetry("2ndKey",{})))},15),d={},k="MetricsProviderWrapper",tt=o.ItemDataModelStore.Instance(),it="Failed to find a common grain",ut={};ft=(function(){function n(n,t){this.telemContext=n;this.providerFactory=new w.RootProviderFactory(this.telemContext,t)}return n.Instance=function(t,i){var r=ut[t],u,f,e;return r||(u=tt.GetItemDataModel(t),f=s.getOrCreateTelemetryContext(u),r=new n(f,i),u||(e="metricsProvider.Instance: Cannot find itemDataModel in store",s.logError(e,f,e,{ContainerName:k,chartId:t})),ut[t]=r),r},n.prototype.getNamespaces=function(n,t,i){var r=s.AddOperation(k+".getNamespaces",t),u=r.opTimer,f=r.opStop;return g(this.providerFactory,n,u).then((function(n){return n.getNamespaces(t,i)})).finally(f)},n.prototype.fetchMetricDefinitions=function(n,t,i,r){if(!n||!a.isValidResourceDefinition(n))return Q.reject({error:"Invalid resourceDefinition"});var u=s.AddOperation(k+".fetchMetricDefinitions",i),f=u.opTimer,e=u.opStop;return t&&t.indexOf(p.RolesPrefix)===0&&(n.id+=t,t=null),g(this.providerFactory,n,f).then((function(n){return n.getMetricDefinitions(i,t,r)})).finally(e)},n.prototype.fetchMetricResults=function(n,t,i,r,f,e){f===void 0&&(f=u.UniqueDimensionValueThreshold);var o=s.AddOperation(k+".fetchMetricResults",i),h=o.opTimer,c=o.opStop;return st.fetch({provider:this,itemDataModel:n,timeContext:t,segmentedTopCount:f,opTelem:h,cause:r,ignoreDataPointLimit:e},r===1).then((function(n){return n.result})).finally(c)},n.prototype.fetchDimensionDefinitions=function(n,t,i,r){var o=this;if(!n)return Q([]);var u=[],f=s.AddOperation(k+".fetchDimensionDefinitions",i),e=f.opTimer,h=f.opStop;return n.forEach((function(n){var t=g(o.providerFactory,n.resourceDefinition,e).then((function(t){return t.getDimensionDefinitions&&t.getDimensionDefinitions([b.ToMetricQueryParams(n)],e,r)}));u.push(t)})),y.joinAggregatePromises(u).then((function(n){if(n){var t=y.uniqueObjects(n,(function(n){return n.dimensionName.id}));return t.sort((function(n,t){var i=n.dimensionName,r=t.dimensionName;return(i.displayName||i.id).localeCompare(r.displayName||r.id)}))}return[]})).finally(h)},n.prototype.fetchDimensionValues=function(n,t,i,r,u,f,e){var a=this;if(n&&n.length>0){var o=s.AddOperation(k+".fetchDimensionValues",f),h=o.opTimer,v=o.opStop,c=[];return n.forEach((function(n){var f=g(a.providerFactory,n.resourceDefinition,h).then((function(f){return f.getDimensionValues&&f.getDimensionValues([b.ToMetricQueryParams(n)],t,l.createFilterQueryData(i),u,r.getTimerange(),h,e)}));c.push(f)})),y.joinAggregatePromises(c).then((function(n){var t=y.uniqueObjects(n,(function(n){return n.value}));return t.sort((function(n,t){return n.value.localeCompare(t.value)}))})).finally(v)}return Q([])},n.prototype.setupTimespan=function(n,t,i,r,f){var g=this,p=b.ToMetricQueryParams(n[0].id),l,w,a;if(p&&p.namespace===u.AILiveNamespace)return l=new Date,w={absolute:{startTime:c.addSeconds(l,-60),endTime:l},timeGrain:"PT1S"},Q(w);if(a=s.AddOperation(k+".setupTimespan",i).opStop,f||!r)return a(),Q(h.getIdealTimeSpan(t,i,f));var o,d=!0,e={userDataStatus:0},nt=r();return nt.then((function(r){var u=[],c={},f,s;return n.forEach((function(n){c[y.GetUniqueMetricId(n.id)]=n.id})),r.filter((function(n){return!!c[y.GetUniqueMetricId(n.metricId)]})).forEach((function(n){n.supportedTimegrains&&n.supportedTimegrains.length>0&&(u=u.length===0?n.supportedTimegrains:y.intersect(u,n.supportedTimegrains),d=!1)})),d?o=h.ConvertToISO8601Grain(h.getGrainDateSpanFromTimeContext(t),i):u&&u.length>0?t.getHasAutoGrain()?o=h.findBestFitTimegrain(u,v.getAbsoluteTimespan(t.cloneMetricTimespan(i)),t.maxBucketCount,t.getGrain()):(f=t.getGrain(),s=h.findChosenGrain(u,f),s?o=s:(e.userDataStatus=9,e.error={message:"GrainNotSupported",responsetext:"User chosen grain '"+f.toString()+"' is not in the supported common grains: "+u.toString()})):(e.userDataStatus=10,e.error={message:"NoCommonGrain",responsetext:"Didn't find a common grain."}),o?Q.resolve(h.getIdealTimeSpan(t,i,o)):Q.reject(e)}),(function(n){return e.error=n,e.userDataStatus=4,Q.reject(e)})).finally((function(){a();o||s.logWarning(it+" or the given grain is not supported by one of the metric.",g.telemContext,undefined,undefined,i)}))},n.prototype.getRootProviderFactory=function(){return this.providerFactory},n})();t.MetricsProviderWrapper=ft}))