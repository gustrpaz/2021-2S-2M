define("MsPortalImpl/Controls/Helpers/Validators",["require","exports","MsPortalImpl.Controls/Fields/Base/FormValidation","MsPortalImpl/Controls/Helpers/Validation","Viva.Controls/Controls/Base/ValidationPlacements/Viva.Css","Viva.Controls/Controls/Base/ValidationPlacements/Viva.DockedBalloon","Viva.Controls/Controls/Base/Viva.Validators"],(function(n,t,i,r,u,f,e){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Validators=void 0;var o=(function(){function n(n,t,r,u,f){var e=this,o;this._diContainer=n;this._validationInitialized=!1;this._doNotTriggerValidStyleChange=!1;this._lastValidated=undefined;this._pendingCount=0;this._pendingResults=[];this._widget=r;this._element=this._widget.element;this._noValidationBalloon=f;this._validationElement=u||this._element;this._viewModel=r.options||r.vm;this.ltm=t;this.validationPlacements=ko.observableArray();this.internalValidators=ko.observableArray();this.validationResults=this._viewModel.validationResults||ko.observableArray();this.validatableViewModel=this._validatable={validators:ko.observableArray(),enableValidation:this._viewModel.enableValidation,valid:this._viewModel.valid,validationState:ko.observable(0)};this.validationState=this._validatable.validationState;o=ko.unwrap(this._viewModel.validations);o&&o.length>0&&(ko.unwrap(this._viewModel.validations).forEach((function(n){e._addValidation(n)})),this._intializeValidation());ko.isObservable(this._viewModel.validations)&&this._subscribeValidationChanges(this._viewModel.validations);this._subscribeValidationChanges(this.internalValidators);this.valid=this._viewModel.valid;this._viewModel._msPortalFxTriggerValidation((function(){return e.triggerValidation()}));this._viewModel._msPortalFxClearValidation((function(){return e._clearValidation(!0),Q()}));i.markFormFieldElement(this._element[0],this._viewModel,this._validatable,this)}return n.prototype.triggerValidation=function(){var n=this,i,e,u,f,o,t;if(this._viewModel&&ko.unwrap(this._viewModel.loading)&&r.shouldValidate(this._viewModel,!1,!1,!1))return this._viewModel.valid(!1),Q(!1);if(i=[],e=this._viewModel.value(),r.shouldValidate(this._viewModel,this._widget.$disabled(),this._widget.isDiposed&&this._widget.isDiposed(),this.internalValidators().length>0))u=this._validatable.validators(),f=this._viewModel.value(),f===undefined||this._viewModel.showValidationMessagesBelowControl||(o=u.some((function(n){return n.valid()})),o!==this._viewModel.valid()&&this._setValidState()),t=r.setValidationStates(u,f,this.ltm),this._pendingResults=[],this._pendingCount=0,this._validatable.validators().forEach((function(t){t.validationState()===3&&i.push(Q.promise((function(i){n._pendingCount++;t.validationState.fxAwaitAndRun(n.ltm,(function(n){return n!==3})).then((function(t){n._pendingCount--;var r=t===2;i(Q(r));n._pendingResults.push(r);n._setValidViaPendingStates()}))})))})),this._viewModel.valid()!==t?this._setValid(t):this._setValidState(t),i.push(Q(t));else return Q(!0);return this._lastValidated=e,Q.all(i).then((function(n){return n.every(MsPortalFx.identity)}))},n.prototype._subscribeValidationChanges=function(n){var t=this;n.subscribeArrayEdits(this.ltm,(function(n){var i=[];t._clearValidation();n.forEach((function(n){n.status==="added"?t._addValidation(n.value):n.status==="deleted"&&i.push(n.value)}));i.length>0&&t._removeValidations(i);t._validationInitialized?t.triggerValidation():t._intializeValidation()}))},n.prototype._intializeValidation=function(){var n=this,t,i;this._validationInitialized=!0;t=this.ltm;i=function(){n.triggerValidation()};this._viewModel.value.subscribe(t,i);this._viewModel.dirty.subscribe(t,(function(t){t&&n._lastValidated!==n._viewModel.value()&&i()}));this._viewModel.validate.subscribe(t,i);this._viewModel.ensureValidation.subscribe(t,i);this._initializeValidationPlacements();this._viewModel.valid.subscribe(t,(function(t){n._doNotTriggerValidStyleChange||n._setValidState(t)}));this._viewModel.enableValidation.subscribe(t,(function(t){n._validatable.validationState(0);t&&n._viewModel.dirty()?i():n._clearValidation(!0)}));this._widget.$disabled.subscribe(t,(function(t){t&&n._clearValidation()}));this._viewModel.loading.subscribe(this.ltm,(function(t){t||n._clearValidation()}));this._viewModel.dirty()&&i();ko.reactor(this.ltm,(function(){n.validationResults(e.getValidationResults(n._validatable.validators))}))},n.prototype._initializeValidationPlacements=function(){var i=this,n=this.ltm,t=this.validationPlacements.removeAll();t.push(new u.Css(n));this._noValidationBalloon||t.push(new f.DockedBalloon(this._diContainer,n,f.DockedBalloon.defaultOptions));this.validationPlacements.subscribeArrayChanges(n,(function(n){n.initialize(i._validationElement,i._validatable)}),(function(n){n.dispose()}));this.validationPlacements(t)},n.prototype._setValid=function(n){var t=this._widget.$disabled();t?this._clearValidation():this._viewModel.valid(n)},n.prototype._setValidState=function(n,t){if(this._widget.$disabled())this._validatable.validationState(0);else{var i=n||this._viewModel.valid(),r=this._validatable.validators().some((function(n){return n.validationState()===1}));(this._pendingCount>0||t)&&!r?(this._setValidWithoutTriggeringStyleUpdate(!1),this._validatable.validationState(3)):i?this._validatable.validationState(2):this._validatable.validationState(1)}},n.prototype._setValidViaPendingStates=function(){var n=!0,t=!1,i;n=this._pendingResults.every((function(n){return n}));n&&this._validatable.validators().every((function(i){var r=i.validationState();return(r===1||r===3)&&(n=!1,r===3&&(t=!0)),n&&!t}));i=this._viewModel.valid();n===i?this._setValidState(n,t):this._setValid(n)},n.prototype._setValidWithoutTriggeringStyleUpdate=function(n){this._doNotTriggerValidStyleChange=!0;this._setValid(n);this._doNotTriggerValidStyleChange=!1},n.prototype._addValidation=function(n){var t=r.convertValidation(this.ltm,n);t&&this._validatable.validators.push(t)},n.prototype._removeValidations=function(n){r.removeValidations(this._validatable,n)},n.prototype._clearValidation=function(n){n&&this.internalValidators([]);this._validatable.validators().forEach((function(n){n.type&&(n.type!==21&&n.validate(undefined),n.validationState(0))}));this._validatable.validationState(0);n&&this._setValidWithoutTriggeringStyleUpdate(!0);this._viewModel.valid(!0)},n})();t.Validators=o}))